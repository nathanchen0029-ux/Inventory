<!DOCTYPE html>

<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Milk Tea Inventory App (v9.6.5 Auto-ID å¼ºåŒ–)</title>
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- iOS full-screen & title -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="åº“å­˜ç³»ç»Ÿ">

  <!-- iOS home screen icon -->
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <!-- Theme color -->
  <meta name="theme-color" content="#0b0d10">

<style>
  :root { --bg:#0b0d10; --panel:#13161a; --text:#e6e6e6; --accent:#8be9fd; --ok:#50fa7b; --warn:#ffb86c; --bad:#ff5555; --card:#1b2027;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif}
  header{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,rgba(19,22,26,.95),rgba(19,22,26,.85));border-bottom:1px solid #2b313b;padding:10px 12px}
  h1{font-size:18px;margin:0 0 6px 0}
  #tabs{display:flex;gap:8px;flex-wrap:wrap}
  #tabs button{background:#212733;color:var(--text);border:1px solid #2b313b;padding:8px 12px;border-radius:10px;cursor:pointer}
  #tabs button.active{background:var(--accent);color:#00141a;font-weight:700}
  main{padding:12px}
  .panel{background:var(--panel);border:1px solid #2b313b;border-radius:14px;padding:12px;margin:12px 0}
  .grid{display:grid;gap:8px}
  .grid.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(200px,1fr))}
  .card{background:var(--card);border:1px solid #2b313b;border-radius:12px;padding:10px}
  label{display:block;font-size:12px;color:#a6b3cf}
  input,select,textarea{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;background:#0f1318;color:#e6e6e6;border:1px solid #2b313b}
  input[type="checkbox"]{width:auto}
  input[readonly]{opacity:.9}
  table{border-collapse:collapse;width:100%;font-size:13px}
  th,td{border-bottom:1px solid #2b313b;padding:8px 6px;text-align:left;vertical-align:middle}
  th{position:sticky;top:0;background:#11161d;z-index:1}
  tr:hover td{background:#0f1318}
  .btn{background:#1d2430;color:var(--text);border:1px solid #2b313b;padding:6px 10px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#00141a;font-weight:700}
  .btn.danger{border-color:#5c2222}
  .btn.ghost{background:transparent;border-color:#2b313b}
  details{background:#121720;border:1px solid #273044;border-radius:10px;padding:6px 10px;margin:8px 0}
  summary{cursor:pointer;color:#a6b3cf}
  input[name="Item ID"], input[data-col="Item ID"]{max-width:140px}
  #error{display:none;margin:12px 12px 0;padding:10px;background:#3b1d1d;border:1px solid #5c2222;border-radius:10px;color:#ffdede;white-space:pre-wrap}
  .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .nowrap{white-space:nowrap}
  .drag-handle{cursor:grab; user-select:none; font-size:16px;}
  tr.dragging{opacity:.6}
  tr.drop-above td{box-shadow:inset 0 3px 0 0 var(--accent)}
  tr.drop-below td{box-shadow:inset 0 -3px 0 0 var(--accent)}
  .muted{color:#8aa0c2;font-size:12px;margin-top:6px}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#2e3543;font-size:12px;margin-left:6px}

  /* === UI polish === */
  table.table-edit input:not([type="checkbox"]),
  table.table-edit select,
  table.table-edit textarea{ width:auto; max-width:100%; }
  input,select,textarea{ transition:border-color .15s, box-shadow .15s; }
  input:focus,select:focus,textarea:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(139,233,253,.25); }
  tbody tr:nth-child(even) td{ background:rgba(255,255,255,.01); }
  th{ box-shadow:0 1px 0 0 #2b313b, 0 2px 8px rgba(0,0,0,.15); }
  .drag-handle{ opacity:.8; }
  .drag-handle:hover{ opacity:1; }
  .badge{ background:#3a4252; }

  /* Orders section titles & divider */
  .section-title{margin:18px 0 8px;font-size:16px;opacity:.9}
  .divider{height:1px;background:#2b313b;margin:20px 0;border:0}

/* --- v9.8.7: remove number spinners for specific fields, tighten columns --- */
input[name="Units per Order Unit"]::-webkit-outer-spin-button,
input[name="Units per Order Unit"]::-webkit-inner-spin-button,
input[name="Safety Stock (base)"]::-webkit-outer-spin-button,
input[name="Safety Stock (base)"]::-webkit-inner-spin-button,
input[name="Base Unit"]::-webkit-outer-spin-button,
input[name="Base Unit"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[name="Units per Order Unit"],
input[name="Safety Stock (base)"],
input[name="Base Unit"] {
  -moz-appearance: textfield;
}
/* Shrink Actions column and the column before it (often Active) */
.table-edit th:last-child, .table-edit td:last-child { width:1%; white-space:nowrap; }
.table-edit th:nth-last-child(2), .table-edit td:nth-last-child(2) { width:1%; white-space:nowrap; }
/* Slightly tighter cell padding */
.table-edit th, .table-edit td { padding: 6px 8px; }


/* --- v9.8.8: stronger spinner removal (also matches data-col in table rows) --- */
input[name="Units per Order Unit"]::-webkit-outer-spin-button,
input[name="Units per Order Unit"]::-webkit-inner-spin-button,
input[name="Safety Stock (base)"]::-webkit-outer-spin-button,
input[name="Safety Stock (base)"]::-webkit-inner-spin-button,
input[name="Base Unit"]::-webkit-outer-spin-button,
input[name="Base Unit"]::-webkit-inner-spin-button,
input[data-col="Units per Order Unit"]::-webkit-outer-spin-button,
input[data-col="Units per Order Unit"]::-webkit-inner-spin-button,
input[data-col="Safety Stock (base)"]::-webkit-outer-spin-button,
input[data-col="Safety Stock (base)"]::-webkit-inner-spin-button,
input[data-col="Base Unit"]::-webkit-outer-spin-button,
input[data-col="Base Unit"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[name="Units per Order Unit"],
input[name="Safety Stock (base)"],
input[name="Base Unit"],
input[data-col="Units per Order Unit"],
input[data-col="Safety Stock (base)"],
input[data-col="Base Unit"] {
  -moz-appearance: textfield;
}


/* v9.8.15: Add Item single-row layout */
.panel .additem-row{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:10px;
  overflow-x:auto;
  align-items:flex-end;
}
.panel .additem-row > *{
  flex: 0 0 auto;
}


/* === Adjustments === */
/* ç§»é™¤ counts ä¸­ç›˜ç‚¹æ•°é‡è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ */
input[name="Count Qty (base)"]::-webkit-outer-spin-button,
input[name="Count Qty (base)"]::-webkit-inner-spin-button,
input[data-col="Count Qty (base)"]::-webkit-outer-spin-button,
input[data-col="Count Qty (base)"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[name="Count Qty (base)"],
input[data-col="Count Qty (base)"] {
  -moz-appearance: textfield;
}
</style>
</head>
<body>
<header>
<h1>æƒŠå¤©åœ°æ³£é¬¼ç¥Håº—åº“å­˜ç³»ç»Ÿï¼ˆv9.8.40ï¼Œç”Ÿæˆäº 2025-09-10ï¼‰</h1>
<div id="tabs"></div>
</header>
<div id="error"></div>
<main id="view"></main>
<input accept="application/json" id="file_json" style="display:none" type="file"/>
<script>
function showErr(msg,stack){var box=document.getElementById('error'); box.style.display='block'; box.textContent='è„šæœ¬é”™è¯¯ï¼š'+msg+(stack?'\n'+stack:'');}
window.addEventListener('error', function(e){ showErr(e.message||'æœªçŸ¥é”™è¯¯', e.error && e.error.stack); });
window.addEventListener('unhandledrejection', function(e){ showErr((e.reason && (e.reason.message||e.reason))||'Promise é”™è¯¯', e.reason && e.reason.stack); });

// ---------- Bootstrap & utils ----------
window.originalData = {"Items": [], "Orders": [], "Counts": [], "Suppliers": [], "Sales": [], "BOM": [], "Settings": {"Categories": [], "Subcategories": [], "OrderUnits": [], "IdRules": {"CategoryCodes": [{"key": "oolong", "code": "1"}, {"key": "gyunami", "code": "2"}, {"key": "oni-giri", "code": "3"}], "SubcategoryCodes": [{"key": "Food (Packed)", "code": "0"}, {"key": "Food (Fresh)", "code": "1"}, {"key": "Packaging", "code": "2"}]}, "IdStrict": true}};
window.state = JSON.parse(JSON.stringify(window.originalData));

const KEY="milk-tea-inventory-app-state-v9_6_5";
try{const saved=localStorage.getItem(KEY); if(saved) state=JSON.parse(saved);}catch(e){}

state.CalcProducts = state.CalcProducts || [];
const today = new Date();
function fmtDate(d){ if(!d) return ""; const dt=new Date(d); if(isNaN(dt)) return ""; return dt.toISOString().slice(0,10); }
function daysBetween(a,b){ const da=new Date(a), db=new Date(b); if(isNaN(da)||isNaN(db)) return null; return Math.round((db-da)/86400000); }
function addDays(dateStr, days){ const d=new Date(dateStr||new Date()); d.setDate(d.getDate()+Number(days||0)); return fmtDate(d);}
function byId(id){return document.getElementById(id)}
function el(tag,attrs){var e=document.createElement(tag); if(attrs){ for(const k in attrs){ if(k==='class') e.className=attrs[k]; else if(k==='html') e.innerHTML=attrs[k]; else e.setAttribute(k,attrs[k]); } } for(var i=2;i<arguments.length;i++){ var kid=arguments[i]; if(kid==null) continue; if(typeof Node!=='undefined' && kid instanceof Node) e.appendChild(kid); else e.appendChild(document.createTextNode(kid)); } return e;}
function groupBy(arr, keyFn){ const m=new Map(); for(const r of (arr||[])){ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r);} return m; }
function saveState(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){ showErr('ä¿å­˜å¤±è´¥: '+e.message); } }
function number(v){ if(v==null || v==='') return 0; const n=Number(v); return isNaN(n)? 0 : n; }
function normSupp(s){ return (s==null? '': String(s)).trim(); }
function normKey(s){ return normSupp(s).toLowerCase(); }
function isActiveFlag(v){ if (typeof v === 'boolean') return v; if (v===1 || v==="1") return true; const s=(v||'').toString().trim().toLowerCase(); return ['true','yes','y','active','on','checked'].includes(s); }
function sortItemsByOrderIndex(items){
  let max = Math.max(0, ...items.map(function(x){return Number.isFinite(x.OrderIndex)? x.OrderIndex : 0;}));
  items.forEach(function(x,i){ if(!Number.isFinite(x.OrderIndex)) { x.OrderIndex = (++max); } });
  items.sort(function(a,b){ return (a.OrderIndex||0) - (b.OrderIndex||0); });
}

// ---------- Lead Time (from 9.6.3) ----------
function toValidDate(v){ if(!v) return null; const s=String(v).trim(); if(!s || s.toLowerCase()==='nat' || s.toLowerCase()==='null' || s==='0000-00-00') return null; const d=new Date(s); return isNaN(d)? null : d; }
function computeSupplierLeadTimesCI(){
  const orders = (state.Orders||[]);
  const poGroups = new Map();
  for(let i=0;i<orders.length;i++){
    const o=orders[i]||{};
    const key = (o['PO Number'] && String(o['PO Number']).trim()) ? String(o['PO Number']).trim() : '__NOPO__'+i;
    if(!poGroups.has(key)) poGroups.set(key, []);
    poGroups.get(key).push(o);
  }
  const recs=[];
  function pick(arr, key, preferHeader){
    if(preferHeader){ const h = arr.find(r=>r && r.isPOHeader && r[key]); if(h) return h[key]; }
    for(const r of arr){ if(r && r[key]) return r[key]; }
    return '';
  }
  function pickLast(arr, key){ for(let i=arr.length-1;i>=0;i--){ const r=arr[i]; if(r && r[key]) return r[key]; } return ''; }
  for(const [po, rows] of poGroups.entries()){
    const supplier = pick(rows, 'Supplier', true) || pick(rows, 'Supplier', false) || '';
    const supplierKey = normKey(supplier);
    const orderDate = pick(rows, 'Order Date', true) || pick(rows, 'Order Date', false) || '';
    const receiveDate = pick(rows, 'Receive Date', true) || pickLast(rows, 'Receive Date') || '';
    const expectedDate = pick(rows, 'Expected Delivery', true) || pick(rows, 'Expected Delivery', false) || '';
    const od = toValidDate(orderDate);
    const rd = toValidDate(receiveDate);
    const ed = toValidDate(expectedDate);
    if(!supplierKey || !od) continue;
    if(rd){ const diff = daysBetween(od, rd); if(diff!=null) recs.push({supplierKey, supplierName:normSupp(supplier), days:diff, when:rd}); }
    else if(ed){ const diff = daysBetween(od, ed); if(diff!=null && diff<=180) recs.push({supplierKey, supplierName:normSupp(supplier), days:diff, when:ed}); }
  }
  recs.sort(function(a,b){ return b.when - a.when; });
  const out={}; for(const r of recs){ if(out[r.supplierKey]) continue; out[r.supplierKey] = {days:r.days, name:r.supplierName}; } return out;
}
function applyLeadTimesToItems(){
  const map = computeSupplierLeadTimesCI();
  let changed=false;
  for(const it of (state.Items||[])){
    const sKey = normKey(it['Supplier']);
    if(sKey && map[sKey]!=null){
      const d = map[sKey].days;
      if(it['Lead Time']!==d){ it['Lead Time']=d; changed=true; }
    }
  }
  if(changed) saveState();
  return map;
}
function leadDaysForSupplierCI(supplier){
  const key = normKey(supplier);
  if(!key) return 0;
  const map = computeSupplierLeadTimesCI();
  if(map[key]!=null) return Number(map[key].days)||0;
  const row=(state.Suppliers||[]).find(function(x){return normKey(x['Supplier'])===key;})||{};
  const manual=Number(row['Shipping Time (days) (manual)']||0);
  return manual>0? manual: 0;
}

// ---------- Auto-ID rules & engine ----------
function ensureSettings(){ state.Settings = state.Settings || {Categories:[],Subcategories:[],OrderUnits:[],CountFreqs:['7','15','30','60'],IdRules:{CategoryCodes:[],SubcategoryCodes:[]}, IdStrict:true, Language:'zh'}; if(!state.Settings.IdRules) state.Settings.IdRules={CategoryCodes:[],SubcategoryCodes:[]}; if(!Array.isArray(state.Settings.CountFreqs)) state.Settings.CountFreqs=['7','15','30','60']; if(!state.Settings.Language) state.Settings.Language='zh'; }
function getIdRules(){ ensureSettings(); return state.Settings.IdRules; }
function codeForCategory(cat){ const key=(cat||'').trim().toLowerCase(); const list=(getIdRules().CategoryCodes||[]); const found=list.find(function(r){ return (r && (r.key||'').trim().toLowerCase())===key; }); return found? String(found.code): null; }
function codeForSubcategory(sub){ const key=(sub||'').trim().toLowerCase(); const list=(getIdRules().SubcategoryCodes||[]); const found=list.find(function(r){ return (r && (r.key||'').trim().toLowerCase())===key; }); return found? String(found.code): null; }
function prefixForItem(it){ const c=codeForCategory(it['Category']); const s=codeForSubcategory(it['Subcategory']); if(c==null || s==null) return null; return String(c)+String(s); }
function reasonForNoId(it){
  const c=codeForCategory(it['Category']); const s=codeForSubcategory(it['Subcategory']);
  if(c==null && s==null) return 'Category ä¸ Subcategory æœªåœ¨è§„åˆ™ä¸­å®šä¹‰';
  if(c==null) return 'Category æœªåœ¨è§„åˆ™ä¸­å®šä¹‰';
  if(s==null) return 'Subcategory æœªåœ¨è§„åˆ™ä¸­å®šä¹‰';
  return '';
}
function computeAutoIDs(allItems){/* legacy full re-number kept for manual use (Settings) */
  // group by 2-digit prefix, then sort by name and assign 2-digit sequence
  const groups=new Map();
  for(const it of (allItems||[])){
    const p=prefixForItem(it);
    if(!p) continue;
    if(!groups.has(p)) groups.set(p, []);
    groups.get(p).push(it);
  }
  const pad=(n)=> String(n).padStart(2,'0');
  for(const [p, arr] of groups.entries()){
    arr.sort(function(a,b){
      const an=(a['Item Name']||'').toString();
      const bn=(b['Item Name']||'').toString();
      const c=an.localeCompare(bn, undefined, {numeric:true,sensitivity:'base'});
      if(c!==0) return c;
      return (a.OrderIndex||0)-(b.OrderIndex||0);
    });
    for(let i=0;i<arr.length;i++){ arr[i]['Item ID']= p + pad(i+1); }
  }
}
function autoAssignItemIDs(){ computeAutoIDs(state.Items||[]); saveState(); }
function nextFreeSeqForPrefix(prefix, startAt){
  startAt = Math.max(1, Number(startAt||1));
  const used = new Set((state.Items||[]).map(function(x){
    const id = String(x['Item ID']||'');
    if(id.startsWith(String(prefix)) && id.length>=4){
      const suf = parseInt(id.slice(2),10);
      if(Number.isFinite(suf)) return suf;
    }
    return null;
  }).filter(function(v){ return v!=null; }));
  let s = startAt;
  while(used.has(s) && s<100){ s++; }
  if(s>=100){ s = 99; while(used.has(s) && s>0){ s--; } } // last resort
  return String(s).padStart(2,'0');
}
function ensureUniqueIdFor(it){
  const p = prefixForItem(it);
  if(!p){ it['Item ID']=''; return false; }
  let current = String(it['Item ID']||'');
  if(current.startsWith(p) && current.length>=4){
    const suf = parseInt(current.slice(2),10);
    if(Number.isFinite(suf)){
      const conflict = (state.Items||[]).find(function(x){ return (x!==it) && String(x['Item ID']||'')===current; });
      if(!conflict){ return true; }
      const next = nextFreeSeqForPrefix(p, suf+1);
      it['Item ID'] = p + next;
      return true;
    }
  }
  const usedNums = (state.Items||[]).map(function(x){
    const id = String(x['Item ID']||''); if(!id.startsWith(p) || id.length<4) return null;
    const n = parseInt(id.slice(2),10); return Number.isFinite(n)? n : null;
  }).filter(function(v){return v!=null;});
  const startAt = usedNums.length? (Math.max.apply(null, usedNums)+1) : 1;
  const next = nextFreeSeqForPrefix(p, startAt);
  it['Item ID'] = p + next;
  return true;
}
function tryAssignIdForOne(it){
  const p = prefixForItem(it);
  if(!p) return false;
  ensureUniqueIdFor(it);
  saveState();
  return true;
}

// ---------- Tabs ----------
const VIEWS=[
  {id:'items',label:'ğŸ—‚ï¸ ç‰©æ–™'},
  {id:'orders',label:'ğŸ§¾ é‡‡è´­'},
    {id:'inventory',label:'ğŸ“¦ åº“å­˜æ€»è§ˆ'},
  {id:'counts',label:'ğŸ“‹ ç›˜ç‚¹'},
  {id:'suppliers',label:'ğŸ·ï¸ ä¾›åº”å•†'},
  {id:'calculator',label:'ğŸ’° æˆæœ¬è®¡ç®—å™¨'},
  {id:'reorder',label:'ğŸ›’ è®¢è´§åŠ©æ‰‹'},
  {id:'settings',label:'âš™ï¸ è®¾ç½®'}
];
function renderTabs(active='items'){ const wrap=byId('tabs'); wrap.innerHTML=''; for(const v of VIEWS){ const b=el('button',{class:v.id===active?'active':''},v.label); b.onclick=function(){render(v.id);}; wrap.appendChild(b);} }

// ---------- Reusable fields ----------
function sfieldFixed(name, options){
  const id='s_'+name.replace(/\s+/g,'_');
  const sel=el('select',{name,id});
  const isFilter = /^ç­›é€‰\s/.test(name) || /^Filter\s/.test(name);
  const lang = (state.Settings && state.Settings.Language) || 'zh';
  (options||[]).forEach(function(o, idx){
    let text = o;
    if(isFilter && idx===0 && (o==='' || o==null)){
      text = (lang==='en') ? 'All' : 'å…¨éƒ¨';
    }
    sel.appendChild(el('option',{value:(o==null?'':o)}, text));
  });
  return el('div',{class:'card'}, el('label',{for:id}, name), sel);
}
function field(name, type='text'){
  const id='f_'+name.replace(/\s+/g,'_');
  const wrap=el('div',{class:'card'}, el('label',{for:id},name), el('input',{name, id, type}));
  if(type==='date') wrap.querySelector('input').value=fmtDate(new Date());
  return wrap;
}
function fieldRO(name, value=''){
  const id='ro_'+name.replace(/\s+/g,'_');
  const inp=el('input',{name, id, value, readonly:true});
  return el('div',{class:'card'}, el('label',{for:id}, name), inp);
}
function collect(container){
  const rec={};
  container.querySelectorAll('input,select,textarea').forEach(function(i){
    if(i.type==='checkbox'){ rec[i.name]= i.checked; }
    else rec[i.name]= i.type==='number' ? (i.value?Number(i.value):'') : i.value;
  });
  return rec;
}
function toCSV(arr){
  if(!Array.isArray(arr) || arr.length===0) return '';
  const cols=[...new Set(arr.flatMap(function(r){ return Object.keys(r||{}); }))];
  function esc(v){ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)? '"'+s+'"' : s; }
  const lines=[cols.join(',')];
  for(const r of arr){ lines.push(cols.map(function(c){ return esc(r[c]); }).join(',')); }
  return lines.join('\n');
}
function download(name, content, mime){
  const blob=new Blob([content],{type:mime||'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(function(){ URL.revokeObjectURL(url); },1000);
}


// ---------- Items ----------
let itemsFilters={cat:'',sub:'',sup:'',activeOnly:false};
function renderItems(root){
  ensureSettings();
  applyLeadTimesToItems();

  const cats=[''].concat(state.Settings.Categories||[]);
  const subs=[''].concat(state.Settings.Subcategories||[]);
  const sups=[''].concat([...new Set((state.Suppliers||[]).map(x=>normSupp(x['Supplier'])).filter(Boolean))].sort());

  const controls=el('div',{class:'panel'}, el('div',{class:'grid cols-3'},
    (function(){const w=sfieldFixed('ç­›é€‰ Category', cats); const s=w.querySelector('select'); s.value=itemsFilters.cat; s.onchange=function(){itemsFilters.cat=s.value; render('items');}; return w;})(),
    (function(){const w=sfieldFixed('ç­›é€‰ Subcategory', subs); const s=w.querySelector('select'); s.value=itemsFilters.sub; s.onchange=function(){itemsFilters.sub=s.value; render('items');}; return w;})(),
    (function(){const w=sfieldFixed('ç­›é€‰ Supplier', sups); const s=w.querySelector('select'); s.value=itemsFilters.sup; s.onchange=function(){itemsFilters.sup=s.value; render('items');}; return w;})()
  ), el('div',{class:'inline', style:'margin-top:6px;'}, (function(){const cb=el('input',{type:'checkbox',id:'onlyActive'}); cb.checked=itemsFilters.activeOnly; cb.onchange=function(){itemsFilters.activeOnly=cb.checked; render('items');}; return cb;})(), el('label',{for:'onlyActive'},'ä»…æ˜¾ç¤º Active')));
  root.appendChild(controls);

  // New item form + ID é¢„è§ˆ
  const form=el('div',{class:'panel'}), grid=el('div',{class:'grid auto'});
  const fiId=fieldRO('Item IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰',''); grid.appendChild(fiId);
  const fiName=field('Item Name','text'); grid.appendChild(fiName);
  (function(){ const w=sfieldFixed('Category', cats); grid.appendChild(w); })();
  (function(){ const w=sfieldFixed('Subcategory', subs); grid.appendChild(w); })();
  grid.appendChild(field('Base Unit','text'));
  (function(){ const w=sfieldFixed('Order Unit', [''].concat(state.Settings.OrderUnits||[])); grid.appendChild(w); })();
  ['Units per Order Unit','Safety Stock (base)'].forEach(function(name){
    var w = field(name,'text'); var inp = w.querySelector('input');
    if(inp){ inp.setAttribute('inputmode','decimal'); inp.setAttribute('pattern','[0-9]*'); }
    grid.appendChild(w);
  });
  (function(){ const w=sfieldFixed('Supplier', sups); grid.appendChild(w); })();
  (function(){ const w=sfieldFixed('Count Freq',[''].concat(state.Settings.CountFreqs||[])); grid.appendChild(w); })();
  const idHint=el('div',{class:'muted',id:'id_hint'}); form.appendChild(grid); form.appendChild(idHint);
  function livePreview(){
    const r=collect(form);
    const c=codeForCategory(r['Category']); const s=codeForSubcategory(r['Subcategory']);
    if(c==null || s==null){
      fiId.querySelector('input').value='';
      idHint.textContent='âš ï¸ æ— æ³•ç”Ÿæˆï¼š'+reasonForNoId(r);
      return;
    }
    const prefix=String(c)+String(s);
    const usedNums = (state.Items||[]).map(function(x){
      const id = String(x['Item ID']||''); if(!id.startsWith(prefix)||id.length<4) return null;
      const n = parseInt(id.slice(2),10); return Number.isFinite(n)? n : null;
    }).filter(function(v){return v!=null;});
    const startAt = usedNums.length? (Math.max.apply(null, usedNums)+1) : 1;
    const id = prefix + nextFreeSeqForPrefix(prefix, startAt);
    fiId.querySelector('input').value=id;
    idHint.textContent='å°†ç”Ÿæˆï¼š'+id+' ï¼ˆè§„åˆ™ï¼šç¬¬1ä½Categoryç  '+c+'ï¼›ç¬¬2ä½Subcategoryç  '+s+'ï¼›åä¸¤ä½æŒ‰åç§°æ’åºåºå·ï¼‰';
  }
  form.addEventListener('input', livePreview);
  livePreview();

  const btnAdd=el('button',{class:'btn primary'},'æ–°å¢ç‰©æ–™');
  btnAdd.onclick=function(){
    const rec=collect(form);
    if(!rec['Item Name']) return alert('Item Name ä¸èƒ½ä¸ºç©º');
    rec['Supplier'] = normSupp(rec['Supplier']);
    var allowed=(state.Settings.CountFreqs||[]).map(String); var v=(rec['Count Freq']||'').toString().trim(); if(v && allowed.indexOf(v)<0){ v=''; } rec['Count Freq']=v;
    rec.Active = true;
    // ä¸¥æ ¼æ¨¡å¼ï¼šæ— æ˜ å°„ä¸è®©æ–°å¢
    if(state.Settings.IdStrict && (!codeForCategory(rec['Category']) || !codeForSubcategory(rec['Subcategory']))){
      return alert('æ— æ³•ç”Ÿæˆ Item IDï¼š'+reasonForNoId(rec)+'ã€‚è¯·å…ˆåˆ° è®¾ç½® â†’ Item ID è§„åˆ™ ä¸­æ·»åŠ æ˜ å°„ï¼Œæˆ–åœ¨ è®¾ç½® é‡Œå…³é—­ä¸¥æ ¼æ¨¡å¼ã€‚');
    }
    let max = Math.max(0, ...(state.Items||[]).map(function(x){return Number.isFinite(x.OrderIndex)? x.OrderIndex : 0;}));
    rec.OrderIndex = max + 1;
    state.Items.push(rec);
    tryAssignIdForOne(rec);
    saveState(); render('items');
  };
  form.appendChild(el('div',{}, btnAdd));
  root.appendChild(form);

  // table
  let rows=(state.Items||[]).slice();
  sortItemsByOrderIndex(rows);
  rows = rows.filter(function(r){
    return (!itemsFilters.cat || r['Category']===itemsFilters.cat)
        && (!itemsFilters.sub || r['Subcategory']===itemsFilters.sub)
        && (!itemsFilters.sup || normSupp(r['Supplier'])===itemsFilters.sup)
        && (!itemsFilters.activeOnly || isActiveFlag(r['Active']));
  });

  const cols=['','Item ID','Item Name','Category','Subcategory','Base Unit','Order Unit','Units per Order Unit','Safety Stock (base)','Count Freq','Supplier','Lead Time','Active'];
  const table=el('table',{class:'table-edit'}); const th=el('thead'); const trh=el('tr'); cols.concat(['æ“ä½œ']).forEach(c=>trh.appendChild(el('th',{},c))); th.appendChild(trh); table.appendChild(th);
  const tb=el('tbody');

  function keyForItem(it){ return String(it['Item ID']||'')+'@@'+String(it['Item Name']||''); }
  function clearDropIndicators(){ tb.querySelectorAll('tr').forEach(function(tr){ tr.classList.remove('drop-above','drop-below'); }); }
  function reorderStateItems(dragKey, targetKey, placeBelow){
    const ordered=state.Items.slice();
    const idxFrom = ordered.findIndex(function(x){ return keyForItem(x)===dragKey; });
    const idxTo = ordered.findIndex(function(x){ return keyForItem(x)===targetKey; });
    if(idxFrom<0 || idxTo<0 || idxFrom===idxTo) return false;
    const [moved]=ordered.splice(idxFrom,1);
    let insertAt = idxTo + (placeBelow?1:0);
    if(idxFrom < idxTo && !placeBelow) insertAt = idxTo-1;
    insertAt = Math.max(0, Math.min(insertAt, ordered.length));
    ordered.splice(insertAt,0,moved);
    ordered.forEach(function(x,i){ x.OrderIndex = i+1; });
    state.Items = ordered;
    saveState();
    return true;
  }

  
// ---- Drag auto-scroll (Items) ----
let _dragScrollActive = false;
document.addEventListener('dragover', function(e){
  if(!_dragScrollActive) return;
  const margin = 80; // px
  const speed = 28;  // px
  const y = e.clientY;
  const h = window.innerHeight || document.documentElement.clientHeight;
  if(y < margin){
    window.scrollBy(0, -speed);
  }else if(y > h - margin){
    window.scrollBy(0, speed);
  }
});

for(const rec of rows){
    const allIdx = state.Items.indexOf(rec);
    const tr=el('tr',{draggable:'true','data-key': keyForItem(rec)});

    (function(){
      const td=el('td',{class:'nowrap drag-handle', title:'æ‹–æ‹½æ’åº'},'â ¿');
      tr.appendChild(td);
    })();

    function tdInput(col){
      const td=el('td');
      if(col==='Item ID'){
        const id=rec['Item ID']||'';
        const inp=el('input',{value:id, readonly:true, title: id? 'æŒ‰è§„åˆ™è‡ªåŠ¨ç”Ÿæˆ' : (reasonForNoId(rec)||'æŒ‰è§„åˆ™è‡ªåŠ¨ç”Ÿæˆ')});
        if(!id){
          const badge=el('span',{class:'badge'}, reasonForNoId(rec)||'æœªç”Ÿæˆ'); td.appendChild(badge);
        }
        td.appendChild(inp);
      } else if(col==='Item Name'){
        const inp=el('input',{value:rec['Item Name']||''});
        inp.addEventListener('change', function(){ rec['Item Name']=inp.value; saveState(); tryAssignIdForOne(rec); render('items'); autosizeAll(document);});
        td.appendChild(inp);
      } else if(col==='Category'){
        const sel = el('select',{'data-col': col}); [''].concat(state.Settings.Categories||[]).forEach(function(o){ sel.appendChild(el('option',{value:o},o));}); sel.value = rec['Category']||''; sel.onchange=function(){ rec['Category']=sel.value; saveState(); tryAssignIdForOne(rec); render('items'); }; td.appendChild(sel);
      } else if(col==='Subcategory'){
        const sel = el('select',{'data-col': col}); [''].concat(state.Settings.Subcategories||[]).forEach(function(o){ sel.appendChild(el('option',{value:o},o));}); sel.value = rec['Subcategory']||''; sel.onchange=function(){ rec['Subcategory']=sel.value; saveState(); tryAssignIdForOne(rec); render('items'); }; td.appendChild(sel);
      } else if(col==='Order Unit'){
        const sel = el('select',{'data-col': col}); [''].concat(state.Settings.OrderUnits||[]).forEach(function(o){ sel.appendChild(el('option',{value:o},o));}); sel.value = rec['Order Unit']||''; sel.onchange=function(){ rec['Order Unit']=sel.value; saveState(); }; td.appendChild(sel);
      } else if(col==='Supplier'){
        const sel = el('select',{'data-col':'Supplier'}); [''].concat(sups).forEach(function(o){ sel.appendChild(el('option',{value:o},o));}); sel.value = normSupp(rec['Supplier'])||''; sel.onchange=function(){ rec['Supplier']=normSupp(sel.value); saveState(); render('items'); }; td.appendChild(sel);
      } else if(col==='Count Freq'){ const sel = el('select',{'data-col':'Count Freq'}); [''].concat(state.Settings.CountFreqs||[]).forEach(function(o){ sel.appendChild(el('option',{value:o},o));}); sel.value = (rec['Count Freq']||'').toString().trim(); sel.onchange=function(){ var allowed=(state.Settings.CountFreqs||[]).map(String); var v=sel.value; if(v && allowed.indexOf(v)<0){ v=''; } rec['Count Freq']=v; saveState(); }; td.appendChild(sel); } else if(col==='Active'){
        const cb=el('input',{type:'checkbox'}); cb.checked=isActiveFlag(rec['Active']); cb.onchange=function(){ rec['Active']=cb.checked; saveState(); }; td.appendChild(cb);
      } else if(col==='Lead Time'){
        const lt = rec['Lead Time']!=null? rec['Lead Time'] : (rec['Supplier'] ? leadDaysForSupplierCI(rec['Supplier']) : ''); const inp=el('input',{value:lt, readonly:true, 'data-col':'Lead Time'}); td.appendChild(inp);
      } else {
        const val = rec[col] ?? ''; const inp = el('input', {value:val, 'data-col': col}); if (typeof val === 'number') inp.type='number'; inp.addEventListener('change', function(){ rec[col] = (inp.type==='number')? Number(inp.value): inp.value; saveState(); }); td.appendChild(inp);
      }
      return td;
    }
    for(const c of cols.slice(1)){ tr.appendChild(tdInput(c)); }
    const tdOp=el('td');
    const btnDel=el('button',{class:'btn danger'},'åˆ é™¤'); btnDel.onclick=function(){ if(confirm('åˆ é™¤è¯¥ç‰©æ–™ï¼Ÿ')){ state.Items.splice(allIdx,1); saveState(); render('items'); } };
    tdOp.appendChild(btnDel); tr.appendChild(tdOp);

    tr.addEventListener('dragstart', function(e){ _dragScrollActive=true;
      tr.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move';
      try{ e.dataTransfer.setData('text/plain', tr.getAttribute('data-key')); }catch(err){}
    });
    tr.addEventListener('dragend', function(){ _dragScrollActive=false; tr.classList.remove('dragging'); clearDropIndicators(); });
    tr.addEventListener('dragover', function(e){ e.preventDefault(); clearDropIndicators(); const rect = tr.getBoundingClientRect(); const mid = rect.top + rect.height/2; if(e.clientY < mid) tr.classList.add('drop-above'); else tr.classList.add('drop-below'); });
    tr.addEventListener('dragleave', function(){ tr.classList.remove('drop-above','drop-below'); });
    tr.addEventListener('drop', function(e){ _dragScrollActive=false;
      e.preventDefault(); clearDropIndicators(); const targetKey = tr.getAttribute('data-key'); const data = e.dataTransfer.getData('text/plain') || ''; if(!data || !targetKey || data===targetKey) return;
      const rect = tr.getBoundingClientRect(); const placeBelow = e.clientY > rect.top + rect.height/2;
      if(reorderStateItems(data, targetKey, placeBelow)){ autoAssignItemIDs(); render('items'); }
    });
    tb.appendChild(tr);
  }
  table.appendChild(tb); root.appendChild(table); autosizeAll(root);
}


// ---------- Inventory Overview (åº“å­˜æ€»è§ˆ) ----------
function renderInventory(root){

  // Helpers
  function toDateOnlyStr(d){
    try{ return fmtDate(d); }catch(e){ return ''; }
  }
  function normKey(s){
    return (s==null)? '' : String(s).trim().toLowerCase();
  }
  const todayStr = fmtDate(new Date());
  const todayMid = new Date(todayStr);

  // Build PO header map and utilities
  const byPO = new Map();
  (state.Orders||[]).forEach(function(r){
    const key = (r['PO Number'] && String(r['PO Number']).trim()) || '(none)';
    if(!byPO.has(key)) byPO.set(key, []);
    byPO.get(key).push(r);
  });
  const poHeader = {};
  for(const [po, rows] of byPO.entries()){
    const h = rows.find(function(x){return x && x.isPOHeader;}) || rows[0] || {};
    poHeader[po] = h || {};
  }
  function hasReceivedHeader(h){
    const rd = h && (h['Receive Date']||h['æ”¶è´§æ—¥æœŸ']);
    if(!rd) return false;
    const d = new Date(rd); if(isNaN(d)) return false;
    const dm = new Date(fmtDate(d));
    return dm <= todayMid;
  }
  function expectedOf(h){
    const lead = leadDaysForSupplierCI(h['Supplier']||h['ä¾›åº”å•†']||'');
    return (h['Expected Delivery'] || h['é¢„è®¡åˆ°è´§'] || addDays(h['Order Date']||h['ä¸‹å•æ—¥æœŸ']||fmtDate(new Date()), lead));
  }

  // Sum inbound between (startExclusive, endInclusive] using Orders Qty(è®¢è´­å•ä½)*Units/è®¢è´­å•ä½
  // Prefer Receive Date; fallback Order Date.
  function sumInboundBetween(itemId, startExclusive, endInclusive){
    if(!itemId) return 0;
    let total = 0;
    (state.Orders||[]).forEach(function(r){
      if(!r || r.isPOHeader) return;
      if((r['Item ID']||'') !== itemId) return;
      const po = (r['PO Number']||'').trim();
      const h = poHeader[po] || {};
      const rdStr = h['Receive Date'] ? fmtDate(new Date(h['Receive Date'])) : (h['æ”¶è´§æ—¥æœŸ']? fmtDate(new Date(h['æ”¶è´§æ—¥æœŸ'])): '');
      const odStr = h['Order Date'] ? fmtDate(new Date(h['Order Date'])) : (h['ä¸‹å•æ—¥æœŸ']? fmtDate(new Date(h['ä¸‹å•æ—¥æœŸ'])): '');
      const useDateStr = rdStr || odStr;
      if(!useDateStr) return;
      if(startExclusive && useDateStr <= startExclusive) return;
      if(endInclusive && useDateStr > endInclusive) return;
      const qtyOU = Number(r['Qty Ordered (è®¢è´­å•ä½)'] ?? r['Qty Ordered (Order Unit)'] ?? r['Qty Ordered'] ?? 0) || 0;
      const unitsPerOU = Number(r['Units per è®¢è´­å•ä½'] ?? r['Units per Order Unit'] ?? r['Units/OU'] ?? 0) || 0;
      total += qtyOU * unitsPerOU;
    });
    return total;
  }

  function earliestOngoingArrival(itemId){
    let best = null; // {dateStr, days, qty}
    for(const [po, rows] of byPO.entries()){
      const h = poHeader[po] || {};
      if(hasReceivedHeader(h)) continue; // only ongoing
      const exp = expectedOf(h);
      const expStr = exp ? toDateOnlyStr(exp) : '';
      if(!expStr) continue;
      const lines = rows.filter(function(x){ return x && !x.isPOHeader && (x['Item ID']||'')===itemId; });
      if(lines.length===0) continue;
      const qty = lines.reduce(function(s,x){
        const q = Number(x['Qty Ordered (è®¢è´­å•ä½)'] ?? x['Qty Ordered (Order Unit)'] ?? x['Qty Ordered'] ?? 0) || 0;
        const u = Number(x['Units per è®¢è´­å•ä½'] ?? x['Units per Order Unit'] ?? x['Units/OU'] ?? 0) || 0;
        return s + q*u;
      }, 0);
      const days = daysBetween(todayStr, expStr);
      if(best==null || expStr < best.dateStr){
        best = {dateStr: expStr, days: days, qty: qty};
      }
    }
    return best;
  }

  function lastTwoCounts(itemId, itemName){
    const all = (state.Counts||[]).filter(function(x){
      if(itemId){ return (x['Item ID']||'')===itemId; }
      return (x['Item Name']||'')===itemName;
    }).slice();
    all.sort(function(a,b){
      const da = new Date(a['Count Date']||a['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01');
      const db = new Date(b['Count Date']||b['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01');
      return db - da; // desc
    });
    const last = all[0] || null;
    const prev = all[1] || null;
    const lastDate = last ? (last['Count Date']||last['ç›˜ç‚¹æ—¥æœŸ']||'') : '';
    const lastQty = last ? Number(last['Count Qty (base)']||last['ç›˜ç‚¹æ•°é‡(åŸºæœ¬å•ä½)']||0) : null;
    const prevDate = prev ? (prev['Count Date']||prev['ç›˜ç‚¹æ—¥æœŸ']||'') : '';
    const prevQty = prev ? Number(prev['Count Qty (base)']||prev['ç›˜ç‚¹æ•°é‡(åŸºæœ¬å•ä½)']||0) : null;
    return { lastDate, lastQty, prevDate, prevQty };
  }

  function computeAUD(itemId, itemName){
    const c = lastTwoCounts(itemId, itemName);
    if(!c.prevDate || c.prevQty==null || !c.lastDate || c.lastQty==null) return null;
    const inbound = sumInboundBetween(itemId, fmtDate(new Date(c.prevDate)), fmtDate(new Date(c.lastDate)));
    const days = daysBetween(c.prevDate, c.lastDate);
    if(!days || days<=0) return null;
    const aud = ((Number(c.prevQty)||0) + inbound - (Number(c.lastQty)||0)) / days;
    if(!isFinite(aud)) return null;
    return aud;
  }

  function inboundAfterLastCount(itemId, lastCountDateStr){
    if(!lastCountDateStr) return 0;
    return sumInboundBetween(itemId, fmtDate(new Date(lastCountDateStr)), todayStr);
  }

  function latestUnitCost(itemId){
    let best = null; // {dateStr, costPerBase}
    (state.Orders||[]).forEach(function(r){
      if(!r || r.isPOHeader) return;
      if((r['Item ID']||'')!==itemId) return;
      const po = (r['PO Number']||'').trim();
      const h = poHeader[po] || {};
      if(!hasReceivedHeader(h)) return;
      const rdStr = fmtDate(h['Receive Date']||h['æ”¶è´§æ—¥æœŸ']||h['Order Date']||h['ä¸‹å•æ—¥æœŸ']||'');

      const qtyOU = Number(r['Qty Ordered (è®¢è´­å•ä½)'] ?? r['Qty Ordered (Order Unit)'] ?? r['Qty Ordered'] ?? 0) || 0;
      const unitsPerOU = Number(r['Units per è®¢è´­å•ä½'] ?? r['Units per Order Unit'] ?? r['Units/OU'] ?? 0) || 0;
      if(qtyOU<=0 || unitsPerOU<=0) return;

      let lineSubtotal = Number(r['Line Subtotal']||r['å°è®¡']||0);
      let allocShip = Number(r['Allocated Shipping (auto)']||r['åˆ†æ‘Šè¿è´¹(è‡ªåŠ¨)']||0);
      let lineTotal = Number(r['Line Total']||r['è¡Œåˆè®¡']||0);
      if(!(lineTotal>0)){
        if(!(lineSubtotal>0)){
          lineSubtotal = qtyOU * (Number(r['Unit Price / Order Unit']||r['è®¢è´­å•ä½å•ä»·']||0) || 0);
        }
        lineTotal = lineSubtotal + (allocShip||0);
      }
      const units = qtyOU * unitsPerOU;
      if(units<=0) return;
      const cpb = lineTotal / units;
      if(!isFinite(cpb) || cpb<=0) return;
      if(!best || rdStr > best.dateStr){
        best = {dateStr: rdStr, costPerBase: cpb};
      }
    });
    return best ? best.costPerBase : null;
  }

  // ----------- Controls (Filters & Sorting) -----------
  // Store normalized keys in state to avoid mismatch by case/space or duplicates
  state.InventoryFilters = state.InventoryFilters || { activeOnly: true, supplier:'', category:'', subcategory:'' };
  // Default 'å…¨éƒ¨' when undefined (do not override existing saved choices)
  if(state.InventoryFilters.supplier == null) state.InventoryFilters.supplier = '';
  if(state.InventoryFilters.category == null) state.InventoryFilters.category = '';
  if(state.InventoryFilters.subcategory == null) state.InventoryFilters.subcategory = '';

  state.InventorySort = state.InventorySort || { key:'default' }; // 'default' | 'recent' | 'avail'

  const panel = el('div',{class:'panel'});

  // toolbar container (single row)
  const toolbar = el('div',{
    class:'toolbar',
    style:'display:flex; align-items:center; gap:12px; flex-wrap:nowrap; overflow:auto; white-space:nowrap;'
  });

  // Active-only toggle
  const activeWrap = el('div',{style:'display:flex; align-items:center; gap:6px;'});
  const cb = el('input',{type:'checkbox',id:'inv_active_only'}); cb.checked = !!state.InventoryFilters.activeOnly;
  cb.onchange = function(){ state.InventoryFilters.activeOnly = cb.checked; saveState(); render('inventory'); };
  activeWrap.appendChild(cb);
  activeWrap.appendChild(el('label',{for:'inv_active_only'}, 'ä»…æ˜¾ç¤º Active ç‰©æ–™'));
  toolbar.appendChild(activeWrap);

  // Build value maps with normalized keys -> display text
  function getItemSupplier(it){ return it['Supplier']||it['ä¾›åº”å•†']||''; }
  function getItemCategory(it){ return it['Category']||it['ç±»åˆ«']||''; }
  function getItemSubcategory(it){ return it['Subcategory']||it['å­ç±»']||''; }

  const itemsAll = (state.Items||[]).slice();
  const supMap = new Map(), catMap = new Map(), subMap = new Map();
  itemsAll.forEach(function(it){
    const s = (getItemSupplier(it)||'').trim(); const sk = normKey(s); if(sk && !supMap.has(sk)) supMap.set(sk, s);
    const c = (getItemCategory(it)||'').trim(); const ck = normKey(c); if(ck && !catMap.has(ck)) catMap.set(ck, c);
    const sc= (getItemSubcategory(it)||'').trim(); const sck= normKey(sc); if(sck && !subMap.has(sck)) subMap.set(sck, sc);
  });

  function mapToSortedEntries(m){
    // return array of [key, label], sorted by label (localeCompare)
    return Array.from(m.entries()).sort(function(a,b){ return a[1].localeCompare(b[1]); });
  }

  function mkSelect(labelTxt, entries, curKey, onchg){
    const wrap = el('div',{style:'display:flex; align-items:center; gap:6px;'});
    wrap.appendChild(el('label',{}, labelTxt+'ï¼š'));
    const sel = el('select',{style:'max-width:240px;'});
    sel.appendChild(el('option',{value:''},'å…¨éƒ¨'));
    entries.forEach(function(pair){
      const k = pair[0], lab = pair[1];
      sel.appendChild(el('option',{value:k, selected: (k===normKey(curKey))}, lab));
    });
    // Ensure selection exact after options
    sel.value = normKey(curKey)||'';
    sel.onchange = function(){ onchg(sel.value||''); };
    wrap.appendChild(sel);
    return wrap;
  }

  toolbar.appendChild(mkSelect('ä¾›åº”å•†', mapToSortedEntries(supMap), state.InventoryFilters.supplier, function(v){ state.InventoryFilters.supplier=v; saveState(); render('inventory'); }));
  toolbar.appendChild(mkSelect('ç±»åˆ«',   mapToSortedEntries(catMap), state.InventoryFilters.category, function(v){ state.InventoryFilters.category=v; saveState(); render('inventory'); }));
  toolbar.appendChild(mkSelect('å­ç±»',   mapToSortedEntries(subMap), state.InventoryFilters.subcategory, function(v){ state.InventoryFilters.subcategory=v; saveState(); render('inventory'); }));

  // Sort control
  const sortWrap = el('div',{style:'display:flex; align-items:center; gap:6px;'});
  sortWrap.appendChild(el('label',{},'æ’åºï¼š'));
  const sortSel = el('select',{});
  [
    {v:'default', t:'é»˜è®¤ï¼ˆæŒ‰ç‰©æ–™é¡ºåºï¼‰'},
    {v:'recent', t:'è¿‘ç›˜ç‚¹æ—¥æœŸï¼ˆæ–°â†’æ—§ï¼‰'},
    {v:'avail',  t:'å¯ç”¨å¤©æ•°ï¼ˆå°‘â†’å¤šï¼‰'}
  ].forEach(function(o){
    sortSel.appendChild(el('option',{value:o.v, selected: state.InventorySort.key===o.v}, o.t));
  });
  sortSel.value = state.InventorySort.key || 'default';
  sortSel.onchange = function(){ state.InventorySort.key = sortSel.value; saveState(); render('inventory'); };
  sortWrap.appendChild(sortSel);
  toolbar.appendChild(sortWrap);

  // Attach toolbar to panel
  panel.appendChild(toolbar);
  root.appendChild(panel);


  // ----------- Export Inventory Report (PDF) -----------
  state.InventoryReport = state.InventoryReport || { date: fmtDate(new Date()) };

  (function(){
    const panelExport = el('div',{class:'panel'});
    const bar = el('div',{class:'inline'});

    const dateWrap = field('åº“å­˜æƒ…å†µæ—¥æœŸ','date');
    const dateInp = dateWrap.querySelector('input');
    dateInp.value = state.InventoryReport.date || fmtDate(new Date());
    dateInp.addEventListener('change', function(){
      state.InventoryReport.date = dateInp.value || fmtDate(new Date());
      saveState();
    });
    bar.appendChild(dateWrap);

    const btn = el('button',{class:'btn primary'},'å¯¼å‡ºåº“å­˜æŠ¥å‘Šï¼ˆPDFï¼‰');
    btn.onclick = function(){
      const asOf = dateInp.value || fmtDate(new Date());
      exportInventoryPDF(asOf);
    };
    bar.appendChild(btn);

    panelExport.appendChild(bar);
    root.appendChild(panelExport);
  })();

  function exportInventoryPDF(asOfDateStr){
    const asOf = fmtDate(new Date(asOfDateStr || new Date()));

    // Reuse helpers & maps from this scope
    function to2(n){ return (n!=null && isFinite(n)) ? Number(n).toFixed(2) : '0.00'; }

    // Build data rows similar to the table, but as-of the chosen date
    const asOfMid = new Date(asOf);

    // Recompute rows with as-of date
    let itemsList = (state.Items||[]).slice();
    sortItemsByOrderIndex(itemsList);
    if(state.InventoryFilters && state.InventoryFilters.activeOnly){
      itemsList = itemsList.filter(function(x){ return isActiveFlag(x['Active']); });
    }
    if(state.InventoryFilters && state.InventoryFilters.supplier){
      const key = state.InventoryFilters.supplier;
      itemsList = itemsList.filter(function(x){ return normKey(getItemSupplier(x))===key; });
    }
    if(state.InventoryFilters && state.InventoryFilters.category){
      const key = state.InventoryFilters.category;
      itemsList = itemsList.filter(function(x){ return normKey(getItemCategory(x))===key; });
    }
    if(state.InventoryFilters && state.InventoryFilters.subcategory){
      const key = state.InventoryFilters.subcategory;
      itemsList = itemsList.filter(function(x){ return normKey(getItemSubcategory(x))===key; });
    }

    function sumInboundBetweenAsOf(itemId, startExclusive, endInclusive){
      if(!itemId) return 0;
      let total = 0;
      (state.Orders||[]).forEach(function(r){
        if(!r || r.isPOHeader) return;
        if((r['Item ID']||'') !== itemId) return;
        const po = (r['PO Number']||'').trim();
        const h = poHeader[po] || {};
        // Receive Date preferred, else Order Date
        const rdStr = h['Receive Date'] ? fmtDate(new Date(h['Receive Date'])) : (h['æ”¶è´§æ—¥æœŸ']? fmtDate(new Date(h['æ”¶è´§æ—¥æœŸ'])): '');
        const odStr = h['Order Date'] ? fmtDate(new Date(h['Order Date'])) : (h['ä¸‹å•æ—¥æœŸ']? fmtDate(new Date(h['ä¸‹å•æ—¥æœŸ'])): '');
        const useDateStr = rdStr || odStr;
        if(!useDateStr) return;
        if(startExclusive && useDateStr <= startExclusive) return;
        if(endInclusive && useDateStr > endInclusive) return;
        const qtyOU = Number(r['Qty Ordered (è®¢è´­å•ä½)'] ?? r['Qty Ordered (Order Unit)'] ?? r['Qty Ordered'] ?? 0) || 0;
        const unitsPerOU = Number(r['Units per è®¢è´­å•ä½'] ?? r['Units per Order Unit'] ?? r['Units/OU'] ?? 0) || 0;
        total += qtyOU * unitsPerOU;
      });
      return total;
    }

    function lastCountOnOrBefore(itemId, itemName, dateStr){
      const tgt = new Date(dateStr);
      const all = (state.Counts||[]).filter(function(x){
        const idOk = itemId ? ((x['Item ID']||'')===itemId) : ((x['Item Name']||'')===itemName);
        if(!idOk) return false;
        const d = new Date(x['Count Date']||x['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01');
        return !isNaN(d) && d <= tgt;
      }).sort(function(a,b){
        return new Date(b['Count Date']||b['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01') - new Date(a['Count Date']||a['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01');
      });
      const last = all[0] || null;
      return {
        lastDate: last ? (last['Count Date']||last['ç›˜ç‚¹æ—¥æœŸ']||'') : '',
        lastQty: last ? Number(last['Count Qty (base)']||last['ç›˜ç‚¹æ•°é‡(åŸºæœ¬å•ä½)']||0) : null
      };
    }

    function computeAUDGlobal(itemId, itemName){
      // Use global last-two-counts AUD as a general daily usage estimate
      const cAll = (state.Counts||[]).filter(function(x){
        return itemId ? ((x['Item ID']||'')===itemId) : ((x['Item Name']||'')===itemName);
      }).sort(function(a,b){
        return new Date(b['Count Date']||b['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01') - new Date(a['Count Date']||a['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01');
      });
      if(cAll.length < 2) return null;
      const last = cAll[0], prev = cAll[1];
      const inbound = sumInboundBetweenAsOf(itemId, fmtDate(new Date(prev['Count Date']||prev['ç›˜ç‚¹æ—¥æœŸ']||'')), fmtDate(new Date(last['Count Date']||last['ç›˜ç‚¹æ—¥æœŸ']||'')));
      const days = daysBetween(prev['Count Date']||prev['ç›˜ç‚¹æ—¥æœŸ']||'', last['Count Date']||last['ç›˜ç‚¹æ—¥æœŸ']||'');
      if(!days || days<=0) return null;
      const aud = ((Number(prev['Count Qty (base)']||0)) + inbound - (Number(last['Count Qty (base)']||0))) / days;
      return (isFinite(aud) ? aud : null);
    }

    const rows = itemsList.map(function(it){
      const itemId = it['Item ID']||'';
      const itemName = it['Item Name']||'';
      const supplier = getItemSupplier(it);

      const c = lastCountOnOrBefore(itemId, itemName, asOf);
      const aud = computeAUDGlobal(itemId, itemName);

      let stock = null;
      if(c.lastDate){
        const days = daysBetween(c.lastDate, asOf);
        const inbound = sumInboundBetweenAsOf(itemId, fmtDate(new Date(c.lastDate)), asOf);
        const useAud = (aud!=null ? aud : 0);
        stock = (Number(c.lastQty)||0) + inbound - (useAud * (isFinite(days)? days: 0));
      }
      const availDays = (aud && aud>0 && stock!=null) ? (stock/aud) : null;
      const cost = latestUnitCost(itemId);
      const value = (cost!=null && stock!=null) ? (cost * stock) : null;

      return {
        supplier: supplier||'',
        itemId: itemId,
        itemName: itemName,
        stock: (stock!=null && isFinite(stock)) ? stock : null,
        aud: (aud!=null && isFinite(aud)) ? aud : null,
        availDays: (availDays!=null && isFinite(availDays)) ? availDays : null,
        cost: (cost!=null && isFinite(cost)) ? cost : null,
        value: (value!=null && isFinite(value)) ? value : null
      };
    });

    // Group by supplier
    const groups = {};
    rows.forEach(function(r){
      const key = normSupp(r.supplier||'(æœªå¡«ä¾›åº”å•†)') || '(æœªå¡«ä¾›åº”å•†)';
      if(!groups[key]) groups[key] = [];
      groups[key].push(r);
    });

    // Build HTML report
    var html = '';
    html += '<!DOCTYPE html><html><head><meta charset="utf-8">';
    html += '<title>åº“å­˜æŠ¥å‘Š - '+ asOf +'</title>';
    html += '<style>';
    html += 'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;color:#111;padding:20px;}';
    html += 'h1{margin:0 0 6px 0;font-size:20px}';
    html += 'h2{margin:18px 0 8px 0;font-size:16px;border-bottom:1px solid #ccc;padding-bottom:4px}';
    html += 'table{border-collapse:collapse;width:100%;font-size:12px;margin:8px 0 14px}';
    html += 'th,td{border:1px solid #ddd;padding:6px 8px;text-align:left}';
    html += 'th{background:#f5f6f8}';
    html += '.right{text-align:right}';
    html += '.total{font-weight:bold}';
    html += '@media print{ .no-print{display:none} }';
    html += '</style></head><body>';
    html += '<div class="no-print" style="text-align:right;margin-bottom:8px;"><button onclick="window.print()">æ‰“å° / å¦å­˜ä¸º PDF</button></div>';
    html += '<h1>åº“å­˜æŠ¥å‘Š</h1>';
    html += '<div>åº“å­˜æƒ…å†µæ—¥æœŸï¼š<strong>'+asOf+'</strong></div>';

    let grand = 0;
    Object.keys(groups).sort().forEach(function(sup){
      const list = groups[sup].slice();
      // sort by item id then name
      list.sort(function(a,b){
        const k1 = (a.itemId||'') + ' ' + (a.itemName||'');
        const k2 = (b.itemId||'') + ' ' + (b.itemName||'');
        return k1.localeCompare(k2, undefined, {numeric:true,sensitivity:'base'});
      });
      let subtotal = 0;
      html += '<h2>ä¾›åº”å•†ï¼š'+ sup +'</h2>';
      html += '<table><thead><tr>';
      ['ç‰©æ–™ç¼–å·','ç‰©æ–™åç§°','ä¼°ç®—åº“å­˜ï¼ˆåŸºç¡€ï¼‰','AUD (/day)','å¯ç”¨å¤©æ•°','æœ€æ–°å•ä½æˆæœ¬','é‡‘é¢'].forEach(function(h){ html += '<th>'+h+'</th>'; });
      html += '</tr></thead><tbody>';
      list.forEach(function(r){
        const amount = (r.value!=null)? r.value : 0;
        subtotal += amount;
        html += '<tr>';
        html += '<td>'+ (r.itemId||'') +'</td>';
        html += '<td>'+ (r.itemName||'') +'</td>';
        html += '<td class="right">'+ (r.stock!=null? to2(r.stock):'') +'</td>';
        html += '<td class="right">'+ (r.aud!=null? to2(r.aud):'') +'</td>';
        html += '<td class="right">'+ (r.availDays!=null? to2(r.availDays):'') +'</td>';
        html += '<td class="right">'+ (r.cost!=null? to2(r.cost):'') +'</td>';
        html += '<td class="right">'+ (r.value!=null? to2(r.value):'') +'</td>';
        html += '</tr>';
      });
      html += '<tr class="total"><td colspan="6">å°è®¡</td><td class="right">'+ to2(subtotal) +'</td></tr>';
      html += '</tbody></table>';
      grand += subtotal;
    });

    html += '<h2>æ€»è®¡ï¼š'+ to2(grand) +'</h2>';
    html += '</body></html>';

    
    // Robust print pipeline: write HTML into a new window to avoid blank PDFs on some browsers.
    try{
      var w = window.open('', '_blank');
      if(w && w.document){
        w.document.open('text/html', 'replace');
        w.document.write(html);
        w.document.close();
        try{ w.document.title='åº“å­˜æŠ¥å‘Š_'+asOf; }catch(e){}
        setTimeout(function(){ try{ w.focus(); w.print(); }catch(e){} }, 200);
      }else{
        // Fallback: hidden iframe
        var iframe = document.createElement('iframe');
        iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
        iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
        document.body.appendChild(iframe);
        var doc = iframe.contentWindow || iframe.contentDocument;
        if(doc.document) doc = doc.document;
        doc.open('text/html', 'replace');
        doc.write(html);
        doc.close();
        try{ doc.title='åº“å­˜æŠ¥å‘Š_'+asOf; }catch(e){}
        setTimeout(function(){ try{ (iframe.contentWindow || iframe).focus(); (iframe.contentWindow || iframe).print(); }catch(e){} }, 200);
        setTimeout(function(){ try{ document.body.removeChild(iframe); }catch(e){} }, 30000);
      }
    }catch(err){
      alert('æ‰“å¼€æ‰“å°çª—å£å¤±è´¥ï¼š'+ (err && err.message ? err.message : err));
    }
}

  // ----------- Build data rows -----------
  let items = (state.Items||[]).slice();
  sortItemsByOrderIndex(items);
  if(state.InventoryFilters.activeOnly){
    items = items.filter(function(x){ return isActiveFlag(x['Active']); });
  }
  if(state.InventoryFilters.supplier){
    const key = state.InventoryFilters.supplier;
    items = items.filter(function(x){ return normKey(getItemSupplier(x))===key; });
  }
  if(state.InventoryFilters.category){
    const key = state.InventoryFilters.category;
    items = items.filter(function(x){ return normKey(getItemCategory(x))===key; });
  }
  if(state.InventoryFilters.subcategory){
    const key = state.InventoryFilters.subcategory;
    items = items.filter(function(x){ return normKey(getItemSubcategory(x))===key; });
  }

  const rows = items.map(function(it){
    const itemId = it['Item ID']||'';
    const itemName = it['Item Name']||'';
    const c = lastTwoCounts(itemId, itemName);
    const aud = computeAUD(itemId, itemName);
    const daysSince = c.lastDate ? daysBetween(c.lastDate, todayStr) : null;
    const inboundAfter = c.lastDate ? inboundAfterLastCount(itemId, c.lastDate) : 0;

    let currentEst = null;
    if(c.lastQty!=null){
      const useAud = (aud!=null? aud: 0);
      currentEst = Number(c.lastQty)||0;
      if(daysSince && daysSince>0) currentEst -= useAud * daysSince;
      currentEst += inboundAfter;
    }
    const availDays = (aud && aud>0 && currentEst!=null)? (currentEst / aud) : null;
    const nxt = earliestOngoingArrival(itemId);
    const nxtDate = nxt? (nxt.dateStr||'') : '';
    const cost = latestUnitCost(itemId);
    const curValue = (cost!=null && currentEst!=null)? (cost * currentEst) : null;

    return {
      itemId, itemName,
      currentEst, aud, availDays, nxtDate, cost, curValue,
      lastDate: c.lastDate || '',
      supplier: getItemSupplier(it),
      category: getItemCategory(it),
      subcategory: getItemSubcategory(it)
    };
  });

  // Sorting
  if(state.InventorySort.key==='recent'){
    rows.sort(function(a,b){
      return (b.lastDate||'').localeCompare(a.lastDate||'');
    });
  }else if(state.InventorySort.key==='avail'){
    rows.sort(function(a,b){
      const avA = (a.availDays==null || isNaN(a.availDays))? Infinity : a.availDays;
      const avB = (b.availDays==null || isNaN(b.availDays))? Infinity : b.availDays;
      return avA - avB;
    });
  }else{
    // keep default order
  }

  // ----------- Table (Reordered columns) -----------
  const cols = ['ç‰©æ–™ç¼–å·','ç‰©æ–™åç§°','å½“å‰åº“å­˜ï¼ˆé¢„ä¼°ï¼‰','AUD (/day)','å¯ç”¨å¤©æ•°','åº“å­˜çŠ¶æ€','ä¸‹æ¬¡åˆ°è´§','æœ€æ–°å•ä½æˆæœ¬','æœ€è¿‘ç›˜ç‚¹æ—¥æœŸ'];
  const table=el('table',{class:'table-edit'});
  const th=el('thead'); const trh=el('tr'); cols.forEach(function(c){ trh.appendChild(el('th',{},c)); }); th.appendChild(trh); table.appendChild(th);
  const tb=el('tbody');

  rows.forEach(function(r){
    const tr=el('tr');
    function td(v){
      const td=el('td'); const inp=el('input',{value:(v==null||v==='')?'':String(v), readonly:true});
      td.appendChild(inp); return td;
    }
    tr.appendChild(td(r.itemId));
    tr.appendChild(td(r.itemName));
    tr.appendChild(td((r.currentEst!=null && isFinite(r.currentEst))? r.currentEst.toFixed(2):''));
    tr.appendChild(td((r.aud!=null && isFinite(r.aud))? r.aud.toFixed(2):''));
    tr.appendChild(td((r.availDays!=null && isFinite(r.availDays))? r.availDays.toFixed(2):''));
    tr.appendChild(td((function(){ const ld = leadDaysForSupplierCI(r.supplier||''); const av = r.availDays; if(ld>0 && av!=null && isFinite(av)){ const ratio = av/ld; return (ratio>=1.8)? 'ğŸŸ¢' : (ratio>=1.5 ? 'ğŸŸ¡' : 'ğŸ”´'); } return '';})()));
    tr.appendChild(td(r.nxtDate||''));
    tr.appendChild(td((r.cost!=null && isFinite(r.cost))? r.cost.toFixed(2):''));
    tr.appendChild(td(r.lastDate||''));
    tb.appendChild(tr);
  });

  table.appendChild(tb);
  root.appendChild(table);

  // Footer total value
  const totalValue = rows.reduce(function(s,x){ const v=(x.curValue!=null && isFinite(x.curValue))? x.curValue : 0; return s+v; }, 0);
  root.appendChild(el('div',{class:'panel'}, el('div',{class:'inline'}, el('div',{}, 'æ€»åº“å­˜ä»·å€¼ï¼ˆä¼°ç®—ï¼‰ï¼š'), el('strong',{}, (isFinite(totalValue)? totalValue.toFixed(2):'0.00')) )));

  try{ autosizeAll(root); }catch(e){ /* ignore */ }

}


// ---------- Cost Calculator (v2.3) ----------
function getLatestUnitCostCI(itemId){
  if(!itemId) return null;
  const todayStr = fmtDate(new Date());
  const todayMid = new Date(todayStr);

  const byPO = new Map();
  (state.Orders||[]).forEach(function(r){
    const key = (r['PO Number'] && String(r['PO Number']).trim()) || '(none)';
    if(!byPO.has(key)) byPO.set(key, []);
    byPO.get(key).push(r);
  });
  const poHeader = {};
  for(const [po, rows] of byPO.entries()){
    const h = rows.find(function(x){return x && x.isPOHeader;}) || rows[0] || {};
    poHeader[po] = h || {};
  }
  function hasReceivedHeader(h){
    const rd = h && (h['Receive Date']||h['æ”¶è´§æ—¥æœŸ']);
    if(!rd) return false;
    const d = new Date(rd); if(isNaN(d)) return false;
    const dm = new Date(fmtDate(d));
    return dm <= todayMid;
  }

  let best = null;
  (state.Orders||[]).forEach(function(r){
    if(!r || r.isPOHeader) return;
    if((r['Item ID']||'')!==itemId) return;
    const po = (r['PO Number']||'').trim();
    const h = poHeader[po] || {};
    if(!hasReceivedHeader(h)) return;
    const rdStr = fmtDate(h['Receive Date']||h['æ”¶è´§æ—¥æœŸ']||h['Order Date']||h['ä¸‹å•æ—¥æœŸ']||'');

    const qtyOU = Number(r['Qty Ordered (è®¢è´­å•ä½)'] ?? r['Qty Ordered (Order Unit)'] ?? r['Qty Ordered'] ?? 0) || 0;
    const unitsPerOU = Number(r['Units per è®¢è´­å•ä½'] ?? r['Units per Order Unit'] ?? r['Units/OU'] ?? 0) || 0;
    if(qtyOU<=0 || unitsPerOU<=0) return;

    let lineSubtotal = Number(r['Line Subtotal']||r['å°è®¡']||0);
    let allocShip = Number(r['Allocated Shipping (auto)']||r['åˆ†æ‘Šè¿è´¹(è‡ªåŠ¨)']||0);
    let lineTotal = Number(r['Line Total']||r['è¡Œåˆè®¡']||0);
    if(!(lineTotal>0)){
      if(!(lineSubtotal>0)){
        lineSubtotal = qtyOU * (Number(r['Unit Price / Order Unit']||r['è®¢è´­å•ä½å•ä»·']||0) || 0);
      }
      lineTotal = lineSubtotal + (allocShip||0);
    }
    const units = qtyOU * unitsPerOU;
    if(units<=0) return;
    const cpb = lineTotal / units;
    if(!isFinite(cpb) || cpb<=0) return;
    if(!best || rdStr > best.dateStr){
      best = {dateStr: rdStr, costPerBase: cpb};
    }
  });
  return best ? best.costPerBase : null;
}

function getItemBaseValue(it){
  if(!it) return 1;
  const keys = [
    'Base Unit Value','åŸºç¡€å•ä½(å€¼)','Base Unit Qty','Base Unit Quantity',
    'Units per Stock Unit','Units/Stock Unit','Units per åº“å­˜å•ä½',
    'Units per Package','Units/Package','Units per åŒ…è£…',
    'Units per Conversion','Units/Base','Units per åŸºç¡€å•ä½'
  ];
  for(const k of keys){
    const v = Number(it[k]);
    if(isFinite(v) && v>0) return v;
  }
  const bv = Number(it['Base Unit']);
  if(isFinite(bv) && bv>0) return bv;
  return 1;
}

function computeProductStats(prod){
  let totalAmount = 0;
  let totalQtyBase = 0;
  (prod.lines||[]).forEach(function(line){
    const info = computeLineInfo(line);
    totalAmount += (isFinite(info.amount)? info.amount : 0);
    totalQtyBase += (isFinite(info.qty)? info.qty : 0);
  });
  return {totalAmount, totalQtyBase};
}

function getItemRawById(id){ return (state.Items||[]).find(function(x){ return (x['Item ID']||'')===id; }); }
function getItemMeta(it){
  if(!it) return {id:'',name:'',base:1,cat:'',subcat:'',sup:''};
  return {
    id: it['Item ID']||'',
    name: it['Item Name']||'',
    base: getItemBaseValue(it),
    cat: it['Category']||it['ç±»åˆ«']||'',
    subcat: it['Subcategory']||it['å­ç±»åˆ«']||'',
    sup: it['Supplier']||it['ä¾›åº”å•†']||''
  };
}

function getPseudoItemForBaseProduct(bp, idx){
  const stats = computeProductStats(bp);
  const baseUnitValue = stats.totalQtyBase>0 ? stats.totalQtyBase : 1;
  return {
    id: 'BP::'+idx,
    name: '[åŸºç¡€äº§å“] '+bp.name,
    base: baseUnitValue,
    cat: '(åŸºç¡€äº§å“)',
    subcat: '',
    sup: '',
    _bpIndex: idx,
    _bpLatestCost: stats.totalAmount
  };
}

function computeLineInfo(line){
  const isBP = Object.prototype.hasOwnProperty.call(line,'bpRef');
  if(isBP){
    const bp = (state.CalcProducts||[])[line.bpRef];
    if(!bp){ return {type:'bp', itemId:'', itemName:'(å·²åˆ é™¤)', baseUnit:1, latestCost:null, qty:Number(line.qty)||0, amount:0}; }
    const stats = computeProductStats(bp);
    const latestCost = stats.totalAmount;
    const baseUnit = stats.totalQtyBase>0 ? stats.totalQtyBase : 1;
    const qty = Number(line.qty)||0;
    const amount = (latestCost/ baseUnit) * qty;
    return {type:'bp', itemId:'BP::'+line.bpRef, itemName: '[åŸºç¡€äº§å“] '+bp.name, baseUnit, latestCost, qty, amount};
  } else {
    const it = getItemRawById(line.itemId) || {};
    const meta = getItemMeta(it);
    const latestCost = getLatestUnitCostCI(meta.id);
    const baseUnit = Number(meta.base)||1;
    const qty = Number(line.qty)||0;
    const amount = (latestCost!=null ? (latestCost/ baseUnit * qty) : 0);
    return {type:'item', itemId: meta.id, itemName: meta.name, baseUnit, latestCost, qty, amount};
  }
}

function to2(n){ return (n!=null && isFinite(n)) ? Number(n).toFixed(2) : ''; }

function renderCalculator(root){
  const addPanel = el('div',{class:'panel'}, 
    el('div',{class:'additem-row'},
      (function(){ const w = field('äº§å“åç§°','text'); return w; })(),
      el('label',{style:'display:flex;align-items:center;gap:.5rem;'}, 
        (function(){ 
          const chk = el('input',{type:'checkbox', name:'is_base_prod'}); 
          return el('span',{}, chk, ' è®¾ä¸ºåŸºç¡€äº§å“'); 
        })()
      ),
      el('button',{class:'btn primary'},'æ–°å¢äº§å“')
    )
  );
  const prodNameInp = addPanel.querySelector('input[name="äº§å“åç§°"]');
  const prodBaseChk = addPanel.querySelector('input[name="is_base_prod"]');
  addPanel.querySelector('button').onclick = function(){
    const name = (prodNameInp.value||'').trim();
    if(!name) return alert('è¯·è¾“å…¥äº§å“åç§°');
    state.CalcProducts = state.CalcProducts || [];
    state.CalcProducts.push({name, isBase: !!prodBaseChk.checked, lines:[]});
    saveState(); render('calculator');
  };
  root.appendChild(addPanel);

  const itemsActive = (state.Items||[]).filter(function(it){ return isActiveFlag(it['Active']); });
  const metas = itemsActive.map(getItemMeta).filter(function(o){ return o.id && o.name; });

  const cats = Array.from(new Set(metas.map(function(m){return m.cat||'';}))).filter(Boolean).sort();
  const subs = Array.from(new Set(metas.map(function(m){return m.subcat||'';}))).filter(Boolean).sort();
  const sups = Array.from(new Set(metas.map(function(m){return m.sup||'';}))).filter(Boolean).sort();

  (state.CalcProducts||[]).forEach(function(prod, idxProd){
    const prodStats = computeProductStats(prod);
    const total = prodStats.totalAmount;

    const det = el('details',{});
    det.open = (prod._open!==undefined) ? !!prod._open : true;
    det.addEventListener('toggle', function(){ prod._open = det.open; saveState(); });
    const sum = el('summary',{}, 'äº§å“ï¼š'+prod.name+' | æ€»ä»·ï¼š'+to2(total));
    det.appendChild(sum);

    const header = el('div',{class:'panel'},
      el('div',{class:'inline', style:'gap:1rem; align-items:center;'},
        (function(){
          const lbl = el('label',{style:'display:flex;align-items:center;gap:.5rem;'},
            (function(){ const c = el('input',{type:'checkbox'}); c.checked = !!prod.isBase; c.onchange=function(){ prod.isBase = !!c.checked; saveState(); render('calculator'); }; return c; })(),
            el('span',{}, 'è®¾ä¸ºåŸºç¡€äº§å“ï¼ˆå¯è¢«å…¶å®ƒäº§å“å½“ä½œåŸæ–™ï¼‰')
          );
          return lbl;
        })(),
        el('div',{}, 'ï¼ˆåŸºç¡€å•ä½=è¯¥äº§å“åŸæ–™ç”¨é‡ä¹‹å’Œï¼Œæœ€æ–°å•ä½æˆæœ¬=æ€»ä»·ï¼‰')
      )
    );
    det.appendChild(header);

    const addRow = el('div',{class:'panel'}, 
      el('div',{class:'additem-row', style:'gap:.75rem; flex-wrap:wrap;'},
        (function(){
          const wrap = el('div',{class:'card', style:'min-width:180px;'},
            el('label',{}, 'ç±»åˆ«'),
            (function(){ const s = el('select',{name:'f_cat_'+idxProd}); s.appendChild(el('option',{value:''},'å…¨éƒ¨')); cats.forEach(function(v){ s.appendChild(el('option',{value:v},v)); }); return s; })()
          );
          return wrap;
        })(),
        (function(){
          const wrap = el('div',{class:'card', style:'min-width:180px;'},
            el('label',{}, 'å­ç±»åˆ«'),
            (function(){ const s = el('select',{name:'f_sub_'+idxProd}); s.appendChild(el('option',{value:''},'å…¨éƒ¨')); subs.forEach(function(v){ s.appendChild(el('option',{value:v},v)); }); return s; })()
          );
          return wrap;
        })(),
        (function(){
          const wrap = el('div',{class:'card', style:'min-width:200px;'},
            el('label',{}, 'ä¾›åº”å•†'),
            (function(){ const s = el('select',{name:'f_sup_'+idxProd}); s.appendChild(el('option',{value:''},'å…¨éƒ¨')); sups.forEach(function(v){ s.appendChild(el('option',{value:v},v)); }); return s; })()
          );
          return wrap;
        })(),
        (function(){
          const w = el('div',{class:'card', style:'min-width:280px;'},
            el('label',{}, 'é€‰æ‹©åŸæ–™ Item / åŸºç¡€äº§å“'),
            el('select',{name:'item_sel_'+idxProd})
          );
          return w;
        })(),
        (function(){ const w = field('ç”¨é‡ï¼ˆæŒ‰åŸºç¡€å•ä½ï¼‰','number'); const inp=w.querySelector('input'); inp.value = '1.00'; inp.step='0.01'; return w; })(),
        el('button',{class:'btn'},'æ·»åŠ åŸæ–™')
      )
    );

    function rebuildItemOptions(){
      const sel = addRow.querySelector('select[name="item_sel_'+idxProd+'"]');
      const fcat = addRow.querySelector('select[name="f_cat_'+idxProd+'"]').value;
      const fsub = addRow.querySelector('select[name="f_sub_'+idxProd+'"]').value;
      const fsup = addRow.querySelector('select[name="f_sup_'+idxProd+'"]').value;
      const itemFiltered = metas.filter(function(m){
        return (!fcat || m.cat===fcat) && (!fsub || m.subcat===fsub) && (!fsup || m.sup===fsup);
      });
      const bpItems = (state.CalcProducts||[]).map(function(p,i){ return p && p.isBase ? getPseudoItemForBaseProduct(p,i) : null; }).filter(Boolean);
      sel.innerHTML = '';
      sel.appendChild(el('option',{value:''},'è¯·é€‰æ‹©'));
      itemFiltered.forEach(function(o){ sel.appendChild(el('option',{value:o.id}, o.id+' - '+o.name)); });
      if(bpItems.length){
        const og = el('optgroup',{label:'åŸºç¡€äº§å“'});
        bpItems.forEach(function(b){
          const opt = el('option',{value:b.id}, b.name);
          og.appendChild(opt);
        });
        sel.appendChild(og);
      }
    }

    addRow.querySelector('select[name="f_cat_'+idxProd+'"]').onchange = rebuildItemOptions;
    addRow.querySelector('select[name="f_sub_'+idxProd+'"]').onchange = rebuildItemOptions;
    addRow.querySelector('select[name="f_sup_'+idxProd+'"]').onchange = rebuildItemOptions;
    rebuildItemOptions();

    const sel = addRow.querySelector('select[name="item_sel_'+idxProd+'"]');
    const qtyInp = addRow.querySelector('input[name="ç”¨é‡ï¼ˆæŒ‰åŸºç¡€å•ä½ï¼‰"]');
    addRow.querySelector('button').onclick = function(){
      const val = sel.value;
      const qty = Number(qtyInp.value)||0;
      if(!val) return alert('è¯·é€‰æ‹©åŸæ–™');
      if(!(qty>0)) return alert('è¯·è¾“å…¥ç”¨é‡');
      prod.lines = prod.lines || [];
      if(val.startsWith('BP::')){
        const bpIndex = Number(val.split('::')[1])||0;
        prod.lines.push({bpRef: bpIndex, qty: qty});
      }else{
        prod.lines.push({itemId: val, qty: qty});
      }
      saveState(); render('calculator');
    };

    det.appendChild(addRow);

    const cols = ['ç±»å‹','ç‰©æ–™/åŸºç¡€äº§å“','åŸºç¡€å•ä½','æœ€æ–°å•ä½æˆæœ¬','ç”¨é‡ï¼ˆåŸºç¡€ï¼‰','é‡‘é¢','æ“ä½œ'];
    const table = el('table',{class:'table-edit'});
    const th = el('thead'); const trh = el('tr'); cols.forEach(function(c){ trh.appendChild(el('th',{},c)); }); th.appendChild(trh); table.appendChild(th);
    const tb = el('tbody');

    (prod.lines||[]).forEach(function(line, lineIdx){
      const info = computeLineInfo(line);
      const tr = el('tr');
      function ro(v){ const td = el('td'); td.appendChild(el('input',{value:(v==null||v==='')?'':String(v), readonly:true})); return td; }

      tr.appendChild(ro(info.type==='bp'?'åŸºç¡€äº§å“':'ç‰©æ–™'));
      tr.appendChild(ro(info.itemName || info.itemId || ''));
      tr.appendChild(ro(to2(info.baseUnit)));
      tr.appendChild(ro(to2(info.latestCost)));

      const tdQty = el('td'); const inpQ = el('input',{type:'number', step:'0.01', value: to2(info.qty)});
      inpQ.addEventListener('change', function(){ const v=Number(inpQ.value)||0; prod.lines[lineIdx].qty = v; saveState(); render('calculator'); });
      tdQty.appendChild(inpQ); tr.appendChild(tdQty);

      tr.appendChild(ro(to2(info.amount)));

      const tdOp = el('td'); const btnDel = el('button',{class:'btn danger'},'åˆ é™¤'); 
      btnDel.onclick = function(){ prod.lines.splice(lineIdx,1); saveState(); render('calculator'); };
      tdOp.appendChild(btnDel); tr.appendChild(tdOp);

      tb.appendChild(tr);
    });

    table.appendChild(tb);
    det.appendChild(table);

    const footer = el('div',{class:'panel'}, 
      el('div',{class:'inline'},
        el('div',{}, 'æ€»ä»·ï¼š'),
        el('strong',{}, to2(total)),
        (function(){ const b = el('button',{class:'btn danger'},'åˆ é™¤è¯¥äº§å“'); b.onclick=function(){ if(confirm('åˆ é™¤è¯¥äº§å“åŠå…¶åŸæ–™ï¼Ÿ')){ state.CalcProducts.splice(idxProd,1); saveState(); render('calculator'); } }; return b; })()
      )
    );
    det.appendChild(footer);

    root.appendChild(det);
  });

  autosizeAll(root);
}



// ---------- Reorder Helper (è®¢è´§åŠ©æ‰‹) ----------
function renderReorder(root){
  const todayStr = fmtDate(new Date());
  const todayMid = new Date(todayStr);

  const byPO = new Map();
  (state.Orders||[]).forEach(function(r){
    const key = (r['PO Number'] && String(r['PO Number']).trim()) || '(none)';
    if(!byPO.has(key)) byPO.set(key, []);
    byPO.get(key).push(r);
  });
  const poHeader = {};
  for(const [po, rows] of byPO.entries()){
    const h = rows.find(function(x){return x && x.isPOHeader;}) || rows[0] || {};
    poHeader[po] = h || {};
  }
  function hasReceivedHeader(h){
    const rd = h && (h['Receive Date']||h['æ”¶è´§æ—¥æœŸ']);
    if(!rd) return false;
    const d = new Date(rd); if(isNaN(d)) return false;
    const dm = new Date(fmtDate(d));
    return dm <= todayMid;
  }
  function sumInboundBetween(itemId, startExclusive, endInclusive){
    if(!itemId) return 0;
    let total = 0;
    (state.Orders||[]).forEach(function(r){
      if(!r || r.isPOHeader) return;
      if((r['Item ID']||'') !== itemId) return;
      const po = (r['PO Number']||'').trim();
      const h = poHeader[po] || {};
      const rdStr = h['Receive Date'] ? fmtDate(new Date(h['Receive Date'])) : (h['æ”¶è´§æ—¥æœŸ']? fmtDate(new Date(h['æ”¶è´§æ—¥æœŸ'])): '');
      const odStr = h['Order Date'] ? fmtDate(new Date(h['Order Date'])) : (h['ä¸‹å•æ—¥æœŸ']? fmtDate(new Date(h['ä¸‹å•æ—¥æœŸ'])): '');
      const useDateStr = rdStr || odStr;
      if(!useDateStr) return;
      if(startExclusive && useDateStr <= startExclusive) return;
      if(endInclusive && useDateStr > endInclusive) return;
      const qtyOU = Number(r['Qty Ordered (è®¢è´­å•ä½)'] ?? r['Qty Ordered (Order Unit)'] ?? r['Qty Ordered'] ?? 0) || 0;
      const unitsPerOU = Number(r['Units per è®¢è´­å•ä½'] ?? r['Units per Order Unit'] ?? r['Units/OU'] ?? 0) || 0;
      total += qtyOU * unitsPerOU;
    });
    return total;
  }
  function lastTwoCounts(itemId, itemName){
    const all = (state.Counts||[]).filter(function(x){
      if(itemId){ return (x['Item ID']||'')===itemId; }
      return (x['Item Name']||'')===itemName;
    }).slice();
    all.sort(function(a,b){
      const da = new Date(a['Count Date']||a['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01');
      const db = new Date(b['Count Date']||b['ç›˜ç‚¹æ—¥æœŸ']||'1970-01-01');
      return db - da;
    });
    const last = all[0] || null;
    const prev = all[1] || null;
    const lastDate = last ? (last['Count Date']||last['ç›˜ç‚¹æ—¥æœŸ']||'') : '';
    const lastQty = last ? Number(last['Count Qty (base)']||last['ç›˜ç‚¹æ•°é‡(åŸºæœ¬å•ä½)']||0) : null;
    const prevDate = prev ? (prev['Count Date']||prev['ç›˜ç‚¹æ—¥æœŸ']||'') : '';
    const prevQty = prev ? Number(prev['Count Qty (base)']||prev['ç›˜ç‚¹æ•°é‡(åŸºæœ¬å•ä½)']||0) : null;
    return { lastDate, lastQty, prevDate, prevQty };
  }
  function computeAUD(itemId, itemName){
    const c = lastTwoCounts(itemId, itemName);
    if(!c.prevDate || c.prevQty==null || !c.lastDate || c.lastQty==null) return null;
    const inbound = sumInboundBetween(itemId, fmtDate(new Date(c.prevDate)), fmtDate(new Date(c.lastDate)));
    const days = daysBetween(c.prevDate, c.lastDate);
    if(!days || days<=0) return null;
    const aud = ((Number(c.prevQty)||0) + inbound - (Number(c.lastQty)||0)) / days;
    if(!isFinite(aud)) return null;
    return aud;
  }
  function inboundAfterLastCount(itemId, lastCountDateStr){
    if(!lastCountDateStr) return 0;
    return sumInboundBetween(itemId, fmtDate(new Date(lastCountDateStr)), todayStr);
  }

  state.Reorder = state.Reorder || { supplierKey:'', targetDays: 7, selected: [] };
  function to2(n){ return (n!=null && isFinite(n)) ? Number(n).toFixed(2) : '0.00'; }

  const supSet = new Set();
  (state.Items||[]).forEach(function(it){
    if(!isActiveFlag(it['Active'])) return;
    const s = normSupp(it['Supplier']||'');
    if(s) supSet.add(s);
  });
  const supList = Array.from(supSet).sort();

  const panel = el('div',{class:'panel'});
  const toolbar = el('div',{class:'additem-row', style:'gap:.75rem; flex-wrap:wrap;'});
  (function(){
    const w = field('é¢„è®¡ä½¿ç”¨å¤©æ•°','number');
    const inp = w.querySelector('input');
    inp.step='0.01'; inp.value = (state.Reorder.targetDays!=null)? String(state.Reorder.targetDays) : '7.00';
    inp.addEventListener('change', function(){ state.Reorder.targetDays = Number(inp.value)||0; saveState(); });
    toolbar.appendChild(w);
  })();
  (function(){
    const wrap = el('div',{class:'card', style:'min-width:220px;'},
      el('label',{}, 'ä¾›åº”å•†'),
      (function(){
        const sel = el('select',{name:'reorder_supplier'});
        sel.appendChild(el('option',{value:''}, 'è¯·é€‰æ‹©'));
        supList.forEach(function(s){ sel.appendChild(el('option',{value:s}, s)); });
        sel.value = state.Reorder.supplierKey || '';
        sel.onchange = function(){ state.Reorder.supplierKey = sel.value || ''; state.Reorder.selected = []; saveState(); render('reorder'); };
        return sel;
      })()
    );
    toolbar.appendChild(wrap);
  })();
  (function(){
    const wrap = el('div',{class:'card', style:'min-width:300px;'},
      el('label',{}, 'é€‰æ‹©æœ¬æ¬¡éœ€è¦è®¢è´§çš„ Item'),
      (function(){
        const sel = el('select',{name:'reorder_item'});
        sel.appendChild(el('option',{value:''}, 'è¯·é€‰æ‹©'));
        const itemsActive = (state.Items||[]).filter(function(it){
          const s = normSupp(it['Supplier']||'');
          const okSup = state.Reorder.supplierKey ? (s===state.Reorder.supplierKey) : true;
          return isActiveFlag(it['Active']) && okSup;
        });
        itemsActive.sort(function(a,b){ return (a.OrderIndex||0) - (b.OrderIndex||0); });
        itemsActive.forEach(function(it){ sel.appendChild(el('option',{value: it['Item ID']||''}, (it['Item ID']||'')+' - '+(it['Item Name']||''))); });
        return sel;
      })()
    );
    toolbar.appendChild(wrap);
  })();
  const btnAdd = el('button',{class:'btn'},'æ·»åŠ åˆ°æœ¬æ¬¡è®¢è´§');
  btnAdd.onclick = function(){
    const sel = toolbar.querySelector('select[name="reorder_item"]');
    const val = sel && sel.value;
    if(!val) return alert('è¯·é€‰æ‹©ä¸€ä¸ª Item');
    const arr = state.Reorder.selected || [];
    if(!arr.includes(val)) arr.push(val);
    state.Reorder.selected = arr;
    saveState(); render('reorder');
  };
  const btnAddAll = el('button',{class:'btn ghost'},'â• ä¸€é”®æ·»åŠ è¯¥ä¾›åº”å•†å…¨éƒ¨ç‰©æ–™');
  btnAddAll.onclick = function(){
    const key = state.Reorder.supplierKey || '';
    if(!key) return alert('è¯·å…ˆé€‰æ‹©ä¾›åº”å•†');
    const itemsActive = (state.Items||[]).filter(function(it){ return isActiveFlag(it['Active']) && normSupp(it['Supplier']||'')===key; });
    const ids = itemsActive.map(function(it){ return it['Item ID']||''; }).filter(Boolean);
    const set = new Set(state.Reorder.selected || []);
    ids.forEach(function(id){ set.add(id); });
    state.Reorder.selected = Array.from(set);
    saveState(); render('reorder');
  };
  toolbar.appendChild(btnAdd);
  toolbar.appendChild(btnAddAll);

  panel.appendChild(toolbar);
  root.appendChild(panel);

  const selIds = (state.Reorder.selected||[]).slice();
  const rows = selIds.map(function(id){
    const it = (state.Items||[]).find(function(x){ return (x['Item ID']||'')===id; }) || {};
    const name = it['Item Name']||'';
    const c = lastTwoCounts(id, name);
    const aud = computeAUD(id, name);
    const inboundAfter = c.lastDate ? inboundAfterLastCount(id, c.lastDate) : 0;
    const daysSince = c.lastDate ? daysBetween(c.lastDate, todayStr) : 0;
    let currentEst = null;
    if(c.lastQty!=null){
      const useAud = (aud!=null? aud: 0);
      currentEst = Number(c.lastQty)||0;
      if(daysSince && daysSince>0) currentEst -= useAud * daysSince;
      currentEst += inboundAfter;
    }
    const availDays = (aud && aud>0 && currentEst!=null)? (currentEst / aud) : null;
    const cost = getLatestUnitCostCI(id);
    return { id, name, aud, availDays, currentEst, cost, lastDate: c.lastDate||'' };
  });

  const det = el('details',{}); det.open = true;
  det.appendChild(el('summary',{}, 'è®¢è´§æ¸…å•ï¼ˆå·²é€‰æ‹© '+rows.length+' é¡¹ï¼‰'));
  const cols = ['Item ID','Item Name','AUD (/day)','å¯ç”¨å¤©æ•°','é¢„è®¡ä½¿ç”¨å¤©æ•°','å»ºè®®è®¢è´§é‡ï¼ˆåŸºç¡€ï¼‰','æœ€æ–°å•ä½æˆæœ¬','é‡‘é¢','æ“ä½œ'];
  const table = el('table',{class:'table-edit'});
  const th = el('thead'); const trh = el('tr'); cols.forEach(function(c){ trh.appendChild(el('th',{},c)); }); th.appendChild(trh); table.appendChild(th);
  const tb = el('tbody');

  let totalAmount = 0;

  rows.forEach(function(r){
    const tr = el('tr');
    function ro(v){ const td = el('td'); td.appendChild(el('input',{value:(v==null||v==='')?'':String(v), readonly:true})); return td; }
    const audVal = (r.aud!=null && isFinite(r.aud))? r.aud : null;
    const avail = (r.availDays!=null && isFinite(r.availDays))? r.availDays : 0;
    const tDays = Number(state.Reorder.targetDays)||0;
    let qty = 0;
    if(audVal!=null && isFinite(audVal) && audVal>0){
      const gap = tDays - (isFinite(avail)? avail : 0);
      qty = gap * audVal;
      if(!(qty>0)) qty = 0;
    } else {
      qty = 0;
    }
    qty = Math.max(0, qty);
    const amount = (r.cost!=null && isFinite(r.cost))? (r.cost * qty) : 0;
    totalAmount += amount;

    tr.appendChild(ro(r.id));
    tr.appendChild(ro(r.name));
    tr.appendChild(ro(audVal!=null? to2(audVal):''));
    tr.appendChild(ro((r.availDays!=null && isFinite(r.availDays))? to2(r.availDays):''));
    tr.appendChild(ro(to2(tDays)));
    tr.appendChild(ro(to2(qty)));
    tr.appendChild(ro((r.cost!=null && isFinite(r.cost))? to2(r.cost):''));
    tr.appendChild(ro(to2(amount)));

    const tdOp = el('td');
    const btnDel = el('button',{class:'btn danger'},'ç§»é™¤');
    btnDel.onclick = function(){
      state.Reorder.selected = (state.Reorder.selected||[]).filter(function(x){ return x!==r.id; });
      saveState(); render('reorder');
    };
    tdOp.appendChild(btnDel);
    tr.appendChild(tdOp);

    tb.appendChild(tr);
  });

  table.appendChild(tb);
  det.appendChild(table);

  const footer = el('div',{class:'panel'},
    el('div',{class:'inline'},
      el('div',{}, 'æ€»ä»·ï¼ˆä¼°ç®—ï¼‰ï¼š'),
      el('strong',{}, to2(totalAmount)),
      (function(){
        const b = el('button',{class:'btn'},'å¯¼å‡ºè®¢è´§æ¸…å•ï¼ˆCSVï¼‰');
        b.onclick = function(){
          const arr = rows.map(function(r){
            const audVal = (r.aud!=null && isFinite(r.aud))? r.aud : null;
            const avail = (r.availDays!=null && isFinite(r.availDays))? r.availDays : 0;
            const tDays = Number(state.Reorder.targetDays)||0;
            let qty = 0;
            if(audVal!=null && isFinite(audVal) && audVal>0){
              const gap = tDays - (isFinite(avail)? avail : 0);
              qty = gap * audVal;
              if(!(qty>0)) qty = 0;
            } else { qty = 0; }
            const amount = (r.cost!=null && isFinite(r.cost))? (r.cost * qty) : 0;
            return {
              'Supplier': state.Reorder.supplierKey || '',
              'Item ID': r.id,
              'Item Name': r.name,
              'AUD (/day)': audVal!=null? to2(audVal):'',
              'å¯ç”¨å¤©æ•°': (r.availDays!=null && isFinite(r.availDays))? to2(r.availDays):'',
              'é¢„è®¡ä½¿ç”¨å¤©æ•°': to2(tDays),
              'å»ºè®®è®¢è´§é‡ï¼ˆåŸºç¡€ï¼‰': to2(qty),
              'æœ€æ–°å•ä½æˆæœ¬': (r.cost!=null && isFinite(r.cost))? to2(r.cost):'',
              'é‡‘é¢': to2(amount)
            };
          });
          const csv = toCSV(arr);
          download('Reorder_List_'+(state.Reorder.supplierKey||'')+'_'+todayStr+'.csv', csv, 'text/csv');
        };
        return b;
      })(),
      (function(){
        const b = el('button',{class:'btn danger'},'æ¸…ç©ºæœ¬æ¬¡é€‰æ‹©');
        b.onclick = function(){ state.Reorder.selected = []; saveState(); render('reorder'); };
        return b;
      })()
    )
  );
  det.appendChild(footer);

  root.appendChild(det);
  autosizeAll(root);
}

// ---------- Suppliers ----------
function renderSuppliers(root){
  const form=el('div',{class:'panel'}, el('div',{class:'grid auto'},
    field('Supplier'), field('Contact Name'), field('Phone'), field('Email'), field('Notes'), field('Shipping Time (days) (manual)','number')
  ), el('div',{}, el('button',{class:'btn primary'},'ä¿å­˜/æ›´æ–°ä¾›åº”å•†')));
  form.querySelector('button').onclick=function(){
    const r=collect(form); if(!r['Supplier']) return alert('è¯·è¾“å…¥ Supplier');
    r['Supplier']=normSupp(r['Supplier']);
    let row=state.Suppliers.find(function(x){return normKey(x['Supplier'])===normKey(r['Supplier']);}); if(!row){ row={'Supplier':r['Supplier']}; state.Suppliers.push(row);}
    row['Supplier']=r['Supplier']; row['Contact Name']=r['Contact Name']||''; row['Phone']=r['Phone']||''; row['Email']=r['Email']||''; row['Notes']=r['Notes']||''; row['Shipping Time (days) (manual)']=r['Shipping Time (days) (manual)']||'';
    saveState(); alert('å·²ä¿å­˜ä¾›åº”å•†ä¿¡æ¯'); render('suppliers');
  };
  root.appendChild(form);

  const cols=['Supplier','Contact Name','Phone','Email','Shipping Time (days) (manual)','Notes'];
  const table=el('table',{class:'table-edit'}); const th=el('thead'); const trh=el('tr'); cols.concat(['æ“ä½œ']).forEach(c=>trh.appendChild(el('th',{},c))); th.appendChild(trh); table.appendChild(th);
  const tb=el('tbody');
  for(const r of (state.Suppliers||[])){
    const tr=el('tr'); for(const c of cols){ tr.appendChild(el('td',{}, String(r[c]??''))); }
    const tdOp=el('td'); const btnDel=el('button',{class:'btn danger'},'åˆ é™¤è¯¥ä¾›åº”å•†'); btnDel.onclick=function(){ if(!confirm('åˆ é™¤ä¾›åº”å•† "'+(r['Supplier']||'')+'"?\nä¸ä¼šåˆ é™¤å·²æœ‰è®¢å•æˆ–ç‰©æ–™ï¼Œåªä»ä¾›åº”å•†åˆ—è¡¨ç§»é™¤ã€‚')) return; state.Suppliers = (state.Suppliers||[]).filter(function(x){ return x!==r; }); saveState(); render('suppliers'); };
    tdOp.appendChild(btnDel); tr.appendChild(tdOp); tb.appendChild(tr);
  }
  table.appendChild(tb); root.appendChild(table); autosizeAll(root);
}

// ---------- Counts ----------
function renderCounts(root){
  const itemsActive=(state.Items||[]).filter(function(it){ return isActiveFlag(it['Active']); });
  const itemNames=itemsActive.map(function(x){return x['Item Name'];}).filter(Boolean);
  const grid=el('div',{class:'grid auto'},
    field('Count Date','date'),
    sfieldFixed('Count Freq', [''].concat(state.Settings.CountFreqs||['7','15','30','60'])),
    (function(){ const opts=[''].concat([...new Set((state.Suppliers||[]).map(x=>normSupp(x['Supplier'])).filter(Boolean))].sort()); return sfieldFixed('Supplier', opts); })(),
    sfieldFixed('Category', [''].concat(state.Settings.Categories||[])),
    sfieldFixed('Subcategory', [''].concat(state.Settings.Subcategories||[])),
    el('div',{class:'card'}, el('label',{},'æç¤º'), el('div',{},'ä»…ä» Active ç‰©æ–™ä¸­æŒ‰æ‰€é€‰é¢‘ç‡ç”Ÿæˆç›˜ç‚¹æ¸…å•ï¼ˆé¿å…å¼•å…¥å·²åœç”¨ç‰©æ–™ï¼‰ã€‚')),
    sfieldFixed('Item Name', itemNames), fieldRO('Item ID',''), field('Count Qty (base)','number'), field('Notes')
  );
  const panel=el('div',{class:'panel'} , grid, el('div',{}, el('button',{class:'btn'},'æ–°å¢å•æ¡ç›˜ç‚¹'), el('button',{class:'btn primary',style:'margin-left:8px;'},'ç”Ÿæˆæœ¬æ¬¡ç›˜ç‚¹æ¸…å•ï¼ˆæŒ‰ç­›é€‰æ¡ä»¶ï¼‰')));
  const sel=panel.querySelector('select[name="Item Name"]');
  if(sel) sel.onchange=function(e){ const it=itemsActive.find(function(x){return x['Item Name']===e.target.value;}); if(it) panel.querySelector('input[name="Item ID"]').value=it['Item ID']||''; };
  panel.querySelectorAll('button')[0].onclick=function(){
  const d = panel.querySelector('input[name="Count Date"]').value || fmtDate(new Date());
  const r = collect(panel);
  if(!r['Count Date']) r['Count Date'] = d;
  if(!r['Item ID'] && r['Item Name']){
    const it = (state.Items||[]).find(function(x){ return (x['Item Name']||'')===r['Item Name']; });
    if(it) r['Item ID'] = it['Item ID']||'';
  }
  state.Counts.push(r);
  saveState();
  window.__keepOpenCount = d;
  render('counts');
};
  panel.querySelectorAll('button')[1].onclick=function(){
    const d=panel.querySelector('input[name="Count Date"]').value || fmtDate(new Date());
    const cf=(panel.querySelector('select[name="Count Freq"]').value||'').toString().trim();
    const sup=(panel.querySelector('select[name="Supplier"]')?panel.querySelector('select[name="Supplier"]').value:'').toString().trim();
    const cat=(panel.querySelector('select[name="Category"]')?panel.querySelector('select[name="Category"]').value:'').toString().trim();
    const sub=(panel.querySelector('select[name="Subcategory"]')?panel.querySelector('select[name="Subcategory"]').value:'').toString().trim();
    if(!cf && !sup && !cat && !sub){ return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­›é€‰æ¡ä»¶ï¼ˆç›˜ç‚¹é¢‘ç‡ / ä¾›åº”å•† / Category / Subcategoryï¼‰'); }
    const itemsDue=itemsActive.filter(function(it){
      const okCF = cf ? (String(it['Count Freq']||'').trim()===cf) : true;
      const okSup = sup ? (normKey(it['Supplier'])===normKey(sup)) : true;
      const okCat = cat ? (String(it['Category']||'')===cat) : true;
      const okSub = sub ? (String(it['Subcategory']||'')===sub) : true;
      return okCF && okSup && okCat && okSub;
    });
    let n=0;
    for(const it of itemsDue){
      state.Counts.push({'Count Date': d, 'Item Name': it['Item Name']||'', 'Item ID': it['Item ID']||'', 'Count Qty (base)': '', 'Notes': ''});
      n++;
    }
    saveState(); alert((state.Settings.Language==='en')?('Generated '+n+' item(s) for counting'):('å·²ç”Ÿæˆ '+n+' æ¡éœ€è¦ç›˜ç‚¹çš„ç‰©æ–™è®°å½•')); window.__keepOpenCount=d; render('counts');
  };
  root.appendChild(panel);

  const groups=groupBy(state.Counts||[], function(r){ return r['Count Date']||'(æœªå¡«æ—¥æœŸ)'; }); const dates=[...groups.keys()].sort().reverse();
  for(const d of dates){
    const det=el('details',{}); det.setAttribute('data-date', d); if(window.__keepOpenCount===d){ det.open=true; }
    det.appendChild(el('summary',{}, 'ç›˜ç‚¹æ—¥æœŸï¼š'+d+'ï¼ˆ'+groups.get(d).length+' è¡Œï¼‰'));
    const cols=['Item ID','Item Name','Count Qty (base)','Notes']; const table=el('table',{class:'table-edit'}); const th=el('thead'); const trh=el('tr'); cols.concat(['æ“ä½œ']).forEach(c=>trh.appendChild(el('th',{},c))); th.appendChild(trh); table.appendChild(th);
    const tb=el('tbody');
    for(const rec of groups.get(d)){
      const idx=state.Counts.indexOf(rec);
      const tr=el('tr');
      for(const c of cols){
        const td=el('td');
        const val=rec[c]??'';
        const inp=el('input',{value:val}); if(typeof val==='number') inp.type='number';
        inp.addEventListener('change', function(){ rec[c]= (inp.type==='number')? Number(inp.value): inp.value; saveState(); });
        td.appendChild(inp); tr.appendChild(td);
      }
      const tdOp=el('td'); const btn=el('button',{class:'btn danger'},'åˆ é™¤'); btn.onclick=function(){ if(confirm('åˆ é™¤è¯¥ç›˜ç‚¹è®°å½•ï¼Ÿ')){ state.Counts.splice(idx,1); saveState(); window.__keepOpenCount=d; render('counts'); } }; tdOp.appendChild(btn); tr.appendChild(tdOp);
      tb.appendChild(tr);
    }
    table.appendChild(tb); det.appendChild(table); autosizeAll(det); root.appendChild(el('div',{class:'panel'}, det)); autosizeAll(det);
  }
}

// ---------- Orders ----------
function poNumberFor(supplier, orderDateStr){
  const s = normSupp(supplier);
  const first = s ? s[0].toUpperCase() : 'X';
  const d = orderDateStr ? new Date(orderDateStr) : new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return first + yy + mm + dd;
}
function renderOrders(root){

// --- Lokyo price corrections (from image, grouped by PO header) ---
(function applyLokyoPriceCorrections(){
  if(!state || !Array.isArray(state.Orders)) return;
  function fmt(d){ try{ return fmtDate(new Date(d)); }catch(e){ return String(d||''); } }
  function sameDate(a,b){ return fmt(a)===fmt(b); }
  function like(a,b){ return (String(a||'').toLowerCase().indexOf(String(b||'').toLowerCase())>=0); }
  // Group orders by PO Number to read Supplier/Order Date from header
  const byPO = new Map();
  (state.Orders||[]).forEach(function(r){
    const key = (r['PO Number'] && String(r['PO Number']).trim()) || '(none)';
    if(!byPO.has(key)) byPO.set(key, []);
    byPO.get(key).push(r);
  });
  const edits = [
    {od:'2025-03-11', name:'500 Plastic Cup', price:221.73},
    {od:'2025-03-11', name:'Sealing Film',    price:152.90},
    {od:'2025-03-11', name:'Non-woven Bag',   price:519.40},
    {od:'2025-03-11', name:'Dom Lid Transpa', price:165.67},
    {od:'2025-03-11', name:'Dom Lid Black',   price:193.99},
    {od:'2025-03-11', name:'Flat Lid',        price:138.01},
    {od:'2025-04-28', name:'700 Plastic Cup', price:288.74},
    {od:'2025-08-21', name:'500 Plastic Cup', price:198.13},
    {od:'2025-08-21', name:'Sealing Film',    price:146.66},
    {od:'2025-08-21', name:'Straw',           price:134.21},
  ];
  let changed = 0;
  for(const [po, rows] of byPO.entries()){
    const header = rows.find(x=>x && x.isPOHeader) || rows[0];
    if(!header) continue;
    const sup = (header['Supplier']||'').toString().trim().toLowerCase();
    if(sup !== 'lokyo') continue;
    for(const e of edits){
      if(!sameDate(header['Order Date'], e.od)) continue;
      rows.forEach(function(r){
        if(r && !r.isPOHeader && like(r['Item Name'], e.name)){
          r['Unit Price / Order Unit'] = e.price;
          changed++;
        }
      });
    }
  }
  if(changed>0) saveState();
})();
  const sups=[''].concat([...new Set((state.Suppliers||[]).map(x=>normSupp(x['Supplier'])).filter(Boolean))].sort());
  state.OrdersFilter = state.OrdersFilter || {Supplier:'',From:'',To:''};
  const poGrid=el('div',{class:'grid auto'},
    (function(){ const w=sfieldFixed('Supplier', sups); return w; })(),
    fieldRO('PO Number',''),
    field('Order Date','date'),
    fieldRO('Expected Delivery','ï¼ˆè‡ªåŠ¨æŒ‰ Lead Time è®¡ç®—ï¼‰'),
    field('PO Shipping (enter once)','number')
  );
  const poForm=el('div',{class:'panel'}, el('h3',{},'åˆ›å»ºæ–°çš„é‡‡è´­è®¢å•ï¼ˆPOï¼‰'), poGrid, el('div',{}, el('button',{class:'btn primary'},'æ–°å»º PO')));
  const selSup = poForm.querySelector('select[name="Supplier"]');
  const inpDate = poForm.querySelector('input[name="Order Date"]');
  const roPO = poForm.querySelector('input[name="PO Number"]');
  const roExp = poForm.querySelector('input[name="Expected Delivery"]');
  function updatePO(){
    const sup=normSupp(selSup.value);
    roPO.value = poNumberFor(sup, inpDate.value || fmtDate(new Date()));
    roExp.value = addDays(inpDate.value || fmtDate(new Date()), leadDaysForSupplierCI(sup));
  }
  if(selSup) selSup.onchange=updatePO;
  if(inpDate) inpDate.onchange=updatePO;
  updatePO();
  poForm.querySelector('button').onclick=function(){
    const rec=collect(poForm);
    if(!rec['Supplier']) return alert('è¯·é€‰æ‹© Supplier');
    rec['Supplier']=normSupp(rec['Supplier']);
    rec['PO Number'] = poNumberFor(rec['Supplier'], rec['Order Date'] || fmtDate(new Date()));
    rec['Expected Delivery'] = addDays(rec['Order Date']||fmtDate(new Date()), leadDaysForSupplierCI(rec['Supplier']));
    rec['isPOHeader']=true;
    state.Orders.push(rec);
    saveState();
    render('orders');
  };
  root.appendChild(poForm);

  function expectedOf(h){ const lead = leadDaysForSupplierCI(h['Supplier']||''); return (h['Expected Delivery'] || addDays(h['Order Date']||fmtDate(new Date()), lead)); }

  const byPO=groupBy(state.Orders||[], function(r){ return (r['PO Number']&&String(r['PO Number']).trim()) || '(none)'; });
  const headers=[]; for(const entry of byPO.entries()){ const po=entry[0], rows=entry[1]; const h=rows.find(function(x){return x.isPOHeader;}) || rows[0]; if(h) headers.push(h); }
  headers.sort(function(a,b){ return new Date(b['Order Date']||'1970-01-01') - new Date(a['Order Date']||'1970-01-01'); });

  const baseHeaders = headers.filter(function(h){
    const fs = state.OrdersFilter || {};
    if(fs.Supplier && normKey(h['Supplier'])!==normKey(fs.Supplier)) return false;
    const od = h['Order Date'] ? new Date(h['Order Date']) : null;
    if(fs.From){ const fromD = new Date(fs.From); if(!od || od < fromD) return false; }
    if(fs.To){ const toD = new Date(fs.To); if(!od || od > toD) return false; }
    return true;
  });
  const todayMid = new Date(fmtDate(today));
function hasReceived(h){
  const rd = h && h['Receive Date']; if(!rd) return false;
  const d = new Date(rd); if(isNaN(d)) return false;
  const dm = new Date(fmtDate(d));
  return dm <= todayMid;
}
const ongoing = baseHeaders.filter(function(h){ return !hasReceived(h); });
const delivered = baseHeaders.filter(function(h){ return hasReceived(h); }); 

  function fieldPO(name, obj, type='text', onChange){
    const id='po_'+name.replace(/\s+/g,'_')+'_'+Math.random().toString(36).slice(2,7);
    const inp = el('input',{name:name,id:id,type:type,value: obj[name]||''});
    inp.addEventListener('change', function(){
      obj[name]= inp.type==='number'? Number(inp.value): inp.value;
      saveState();
      if(typeof onChange==='function') onChange();
    });
    return el('div',{class:'card'}, el('label',{for:id}, name), inp);
  }

  function renderPOGroup(title, list, deliveredMode=false){
    if(deliveredMode){ root.appendChild(el('div',{class:'divider'})); }
    root.appendChild(el('h2',{class:'section-title'}, title));
    const sec=el('div',{class:'panel'});
    for(const header of list){
      const po = (header['PO Number']||'(none)').trim();
      const det=el('details',{}); det.setAttribute('data-po', po); if(window.__keepOpenPO===po){ det.open=true; }
      const exp=expectedOf(header);
      const titleText = deliveredMode
        ? 'PO: '+po+' | Supplier: '+(header['Supplier']||'')+' | Order: '+(header['Order Date']||'')+' | Deliver: '+(header['Receive Date']||'')
        : 'PO: '+po+' | Supplier: '+(header['Supplier']||'')+' | Order: '+(header['Order Date']||'')+' | Expected: '+(exp||'');
      (function(){
      const linesForTitle = (state.Orders||[]).filter(function(x){ return (String(x['PO Number']||'').trim()===po) && !x.isPOHeader; });
      const shippingForTitle = Number(header['PO Shipping (enter once)']||0);
      const subtotalForTitle = linesForTitle.reduce(function(s,x){ return s + (Number(x['Qty Ordered (Order Unit)']||0) * Number(x['Unit Price / Order Unit']||0)); }, 0);
      const totalForTitle = linesForTitle.reduce(function(s,x){
        const ls = Number(x['Qty Ordered (Order Unit)']||0) * Number(x['Unit Price / Order Unit']||0);
        const alloc = subtotalForTitle ? (shippingForTitle * ls / subtotalForTitle) : 0;
        return s + (ls + alloc);
      }, 0);
      const titleWithTotal = titleText + ' | æ€»ä»·ï¼š' + (isFinite(totalForTitle)? totalForTitle.toFixed(2):'0.00');
      det.appendChild(el('summary',{}, titleWithTotal));
    })();

      const headerGrid=el('div',{class:'grid auto'},
        (function(){ const w=sfieldFixed('Supplier', [''].concat(sups)); const sel=w.querySelector('select'); sel.value=normSupp(header['Supplier']||''); sel.onchange=function(){ header['Supplier']=normSupp(sel.value); saveState(); applyLeadTimesToItems(); window.__keepOpenPO=po; render('orders'); }; return w; })(),
        fieldPO('Order Date', header, 'date', function(){ applyLeadTimesToItems(); window.__keepOpenPO=po; render('orders'); }),
        fieldRO('Expected Delivery', exp),
        fieldPO('PO Shipping (enter once)', header, 'number', function(){ }),
        fieldPO('Receive Date', header, 'date', function(){ applyLeadTimesToItems(); window.__keepOpenPO=po; render('orders'); })
      );

      const delPOBtn=el('button',{class:'btn danger'},'åˆ é™¤æ•´ä¸ªè®¢å•ï¼ˆPOï¼‰');
      delPOBtn.onclick=function(){ if(confirm('åˆ é™¤æ•´ä¸ª PO '+po+'ï¼Ÿ')){ state.Orders = state.Orders.filter(function(x){ return normSupp(x['PO Number'])!==po; }); saveState(); window.__keepOpenPO=po; render('orders'); } };
      const headerPanel=el('div',{class:'panel'}, headerGrid, el('div',{}, delPOBtn));
      det.appendChild(headerPanel);

      const itemsActive=(state.Items||[]).filter(function(x){ return normKey(x['Supplier'])===normKey(header['Supplier']) && isActiveFlag(x['Active']); });
      const itemNames=itemsActive.map(function(x){ return x['Item Name']; }).filter(Boolean).sort();
      const addLineGrid = el('div',{class:'grid auto'},
        sfieldFixed('Item Name', itemNames),
        fieldRO('Item ID',''),
        field('Qty Ordered (Order Unit)','number'),
        field('Order Unit'),
        field('Units per Order Unit','number'),
        field('Unit Price / Order Unit','number')
      );
      const addLine=el('div',{class:'panel'}, addLineGrid, el('div',{}, el('button',{class:'btn'},'æ–°å¢è¡Œ')));
      
const selName=addLine.querySelector('select[name="Item Name"]');

function __fillFromSelectedItemName(){
  const val = selName ? selName.value : '';
  const it = itemsActive.find(function(x){ return x['Item Name']===val; });
  const idInp  = addLine.querySelector('input[name="Item ID"]');
  const ouInp  = addLine.querySelector('input[name="Order Unit"]');
  const upouInp= addLine.querySelector('input[name="Units per Order Unit"]');
  if(!it){
    if(idInp) idInp.value='';
    if(ouInp) ouInp.value='';
    if(upouInp) upouInp.value='';
    return;
  }
  if(idInp)   idInp.value = it['Item ID'] || '';
  if(ouInp)   ouInp.value = it['Order Unit'] || '';
  if(upouInp) upouInp.value = it['Units per Order Unit'] || '';
}

if(selName){
  selName.addEventListener('change', __fillFromSelectedItemName);
  // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªç‰©æ–™ï¼Œå¹¶ç«‹å³å›å¡«å¯¹åº”å­—æ®µ
  if(selName.options && selName.options.length>0){
    var has = false;
    for(var i=0;i<selName.options.length;i++){ if(selName.options[i].value===selName.value){ has=true; break; } }
    if(!has){ selName.selectedIndex = 0; }
  }
  __fillFromSelectedItemName();
}

addLine.querySelector('button').onclick=function(){
  const rec=collect(addLine);
  rec['PO Number']=po;
  rec['Supplier']=normSupp(header['Supplier']||'');
  rec['Order Date']=header['Order Date']||'';
  rec['Expected Delivery']=exp;
  state.Orders.push(rec);
  saveState();
  window.__keepOpenPO=po;
  render('orders');
};

      det.appendChild(addLine);

      const lines=(state.Orders||[]).filter(function(x){ return normSupp(x['PO Number'])===po && !x.isPOHeader; });
      const cols=['Item ID','Item Name','Qty Ordered (Order Unit)','Order Unit','Units per Order Unit','Unit Price / Order Unit','Line Subtotal','Allocated Shipping (auto)','Line Total'];
      const shipping = Number(header['PO Shipping (enter once)']||0);
      const subtot = lines.reduce(function(s,x){ return s + (Number(x['Qty Ordered (Order Unit)']||0)* Number(x['Unit Price / Order Unit']||0)); }, 0);
      const table=el('table',{class:'table-edit'}); const th=el('thead'); const trh=el('tr'); cols.concat(['æ“ä½œ']).forEach(c=>trh.appendChild(el('th',{},c))); th.appendChild(trh); table.appendChild(th);
      const tb=el('tbody');
      for(const rec of lines){
        rec['Line Subtotal'] = +(Number(rec['Qty Ordered (Order Unit)']||0) * Number(rec['Unit Price / Order Unit']||0)).toFixed(2);
        rec['PO Subtotal (auto)'] = subtot;
        rec['Allocated Shipping (auto)'] = subtot? +(shipping * rec['Line Subtotal'] / subtot).toFixed(2):0;
        rec['Line Total'] = +(rec['Line Subtotal'] + rec['Allocated Shipping (auto)']).toFixed(2);
        const idx=state.Orders.indexOf(rec);
        const tr=el('tr');
        for(const c of cols){
          const td=el('td'); const val=rec[c]??''; const ro=['Line Subtotal','Allocated Shipping (auto)','Line Total'].includes(c);
          const inp=el('input',{value:val, readonly: ro? true: false}); if(typeof val==='number') inp.type='number';
          if(!ro) inp.addEventListener('change', function(){ rec[c]= (inp.type==='number')? Number(inp.value): inp.value; saveState(); });
          td.appendChild(inp); tr.appendChild(td);
        }
        const tdOp=el('td'); const btn=el('button',{class:'btn danger'},'åˆ é™¤'); btn.onclick=function(){ if(confirm('åˆ é™¤è¯¥é‡‡è´­è¡Œï¼Ÿ')){ state.Orders.splice(idx,1); saveState(); window.__keepOpenPO=po; render('orders'); } }; tdOp.appendChild(btn); tr.appendChild(tdOp);
        tb.appendChild(tr);
      }
      table.appendChild(tb);
      det.appendChild(table);

      root.appendChild(det);
    }
    root.appendChild(sec);
  }

  (function(){
    const filterPanel = el('div',{class:'panel'},
      el('h3',{}, 'ç­›é€‰'),
      el('div',{class:'grid auto'},
        (function(){
          const opts = [''].concat([...new Set(headers.map(h=>normSupp(h['Supplier'])).filter(Boolean))].sort());
          const w = sfieldFixed('ç­›é€‰ Supplier', opts);
          const sel = w.querySelector('select');
          sel.value = (state.OrdersFilter && state.OrdersFilter.Supplier) || '';
          sel.onchange=function(){ state.OrdersFilter = state.OrdersFilter || {}; state.OrdersFilter.Supplier = sel.value; saveState(); render('orders'); };
          return w;
        })(),
        (function(){
          const w = field('ç­›é€‰ Order Dateï¼ˆèµ·ï¼‰','date');
          const inp = w.querySelector('input');
          inp.value = (state.ordersFilterStartCache || (state.OrdersFilter && state.OrdersFilter.From) || '');
          inp.onchange=function(){ state.OrdersFilter = state.OrdersFilter || {}; state.OrdersFilter.From = inp.value; state.ordersFilterStartCache=inp.value; saveState(); render('orders'); };
          return w;
        })(),
        (function(){
          const w = field('ç­›é€‰ Order Dateï¼ˆæ­¢ï¼‰','date');
          const inp = w.querySelector('input');
          inp.value = (state.ordersFilterEndCache || (state.OrdersFilter && state.OrdersFilter.To) || '');
          inp.onchange=function(){ state.OrdersFilter = state.OrdersFilter || {}; state.OrdersFilter.To = inp.value; state.ordersFilterEndCache=inp.value; saveState(); render('orders'); };
          return w;
        })()
      )
    );
    root.appendChild(filterPanel);
  })();
  renderPOGroup('â³ Ongoingï¼ˆæœªæ”¶è´§æˆ–æœªåˆ°æœŸï¼‰', ongoing, false);
  renderPOGroup('âœ… Deliveredï¼ˆå·²æ”¶è´§ï¼‰', delivered, true);
}

// ---------- Settings ----------
function renderSimpleList(title, listRef){
  const panel=el('div',{class:'panel'});
  panel.appendChild(el('h3',{}, title));
  const form=el('div',{class:'inline'}, field('æ–°å»º'+title), el('button',{class:'btn'},'æ·»åŠ '));
  form.querySelector('button').onclick=function(){
    const val=normSupp(form.querySelector('input').value.trim());
    if(!val) return;
    if(!state.Settings[listRef].includes(val)) state.Settings[listRef].push(val);
    state.Settings[listRef].sort(); saveState(); render('settings');
  };
  panel.appendChild(form);
  const table=el('table',{class:'table-edit'}); const th=el('thead'); const trh=el('tr'); ['å€¼','æ“ä½œ'].forEach(c=>trh.appendChild(el('th',{},c))); th.appendChild(trh); table.appendChild(th);
  const tb=el('tbody');
  for(const val of (state.Settings[listRef]||[])){
    const tr=el('tr');
    const tdVal=el('td'); const inp=el('input',{value:val}); inp.addEventListener('change', function(){
      const idx=state.Settings[listRef].indexOf(val);
      if(idx>=0){ state.Settings[listRef][idx]=normSupp(inp.value); saveState(); }
    }); tdVal.appendChild(inp);
    const tdOp=el('td'); const del=el('button',{class:'btn danger'},'åˆ é™¤'); del.onclick=function(){ if(confirm('åˆ é™¤è¯¥å€¼ï¼Ÿ')){ state.Settings[listRef]=state.Settings[listRef].filter(function(x){return x!==val;}); saveState(); render('settings'); } }; tdOp.appendChild(del);
    tr.appendChild(tdVal); tr.appendChild(tdOp); tb.appendChild(tr);
  }
  table.appendChild(tb); panel.appendChild(table);
  return panel;
}
function renderCodeTable(title, listName, placeholderKey){
  const panel=el('div',{class:'panel'});
  panel.appendChild(el('h3',{}, title));
  const tbl=el('table'); const th=el('thead'); const trh=el('tr'); ['åç§°åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰','ä»£ç ï¼ˆå•ä¸ªæ•°å­—ï¼‰','æ“ä½œ'].forEach(c=>trh.appendChild(el('th',{},c))); th.appendChild(trh); tbl.appendChild(th);
  const tb=el('tbody');
  const list=(getIdRules()[listName]||[]);
  list.forEach(function(row, idx){
    const tr=el('tr');
    const tdKey=el('td'); const inpK=el('input',{value:row.key||'', placeholder:placeholderKey}); inpK.addEventListener('change', function(){ row.key=inpK.value; saveState(); autoAssignItemIDs(); }); tdKey.appendChild(inpK);
    const tdCode=el('td'); const inpC=el('input',{value:row.code||'', type:'text', placeholder:'0-9'}); inpC.addEventListener('change', function(){ row.code=String(inpC.value).slice(0,1); saveState(); autoAssignItemIDs(); }); tdCode.appendChild(inpC);
    const tdOp=el('td'); const del=el('button',{class:'btn danger'},'åˆ é™¤'); del.onclick=function(){ if(confirm('åˆ é™¤è¯¥æ˜ å°„ï¼Ÿ')){ getIdRules()[listName].splice(idx,1); saveState(); autoAssignItemIDs(); render('settings'); } }; tdOp.appendChild(del);
    tr.appendChild(tdKey); tr.appendChild(tdCode); tr.appendChild(tdOp); tb.appendChild(tr);
  });
  tbl.appendChild(tb);
  const add=el('div',{class:'inline',style:'margin-top:8px;'}, el('input',{placeholder:placeholderKey}), el('input',{placeholder:'0-9',style:'max-width:100px;'}), el('button',{class:'btn'},'æ·»åŠ '));
  add.querySelectorAll('button')[0].onclick=function(){
    const k=add.querySelectorAll('input')[0].value.trim(); const c=add.querySelectorAll('input')[1].value.trim();
    if(!k || !c) return alert('è¯·è¾“å…¥åç§°ä¸ä»£ç ');
    getIdRules()[listName].push({key:k, code:String(c).slice(0,1)});
    saveState(); autoAssignItemIDs(); render('settings');
  };
  panel.appendChild(tbl); panel.appendChild(add);
  return panel;
}
function renderIdRulePanel(){
  const panel=el('div',{class:'panel'});
  panel.appendChild(el('h3',{},'Item ID è§„åˆ™ï¼ˆ4ä½ï¼šç¬¬1ä½=Categoryä»£ç ï¼Œç¬¬2ä½=Subcategoryä»£ç ï¼Œç¬¬3-4ä½=åç§°æ’åºåºå·ï¼‰'));
  const strictWrap=el('div',{class:'inline'});
  const strictCb=el('input',{type:'checkbox',id:'id_strict'}); strictCb.checked= !!state.Settings.IdStrict; strictCb.onchange=function(){ state.Settings.IdStrict = strictCb.checked; saveState(); };
  strictWrap.appendChild(strictCb); strictWrap.appendChild(el('label',{for:'id_strict'},'ä¸¥æ ¼æ¨¡å¼ï¼šæ— æ˜ å°„ä¸å…è®¸æ–°å¢ï¼ˆå…³é—­åå¯å…ˆæ–°å¢ï¼Œç¨åè¡¥å……è§„åˆ™å†ç»Ÿä¸€ç¼–å·ï¼‰'));
  panel.appendChild(strictWrap);
  const regenerate=el('button',{class:'btn primary'},'æŒ‰è§„åˆ™é‡æ–°ç”Ÿæˆæ‰€æœ‰ Item ID');
  regenerate.onclick=function(){ autoAssignItemIDs(); alert('å·²æŒ‰å½“å‰è§„åˆ™é‡æ–°ç”Ÿæˆæ‰€æœ‰ Item ID'); };
  panel.appendChild(regenerate);
  return panel;
}
function renderSettings(root){
  
  // --- Language panel (injection, minimal) ---
  ensureSettings();
  (function(){
    const panel = el('div',{class:'panel'});
    panel.appendChild(el('h3',{},'è¯­è¨€ / Language'));
    const inline = el('div',{class:'inline'});
    const card = el('div',{class:'card'});
    card.appendChild(el('label',{},'ç•Œé¢è¯­è¨€ / UI Language'));
    const sel = el('select',{});
    sel.appendChild(el('option',{value:'zh'},'ä¸­æ–‡'));
    sel.appendChild(el('option',{value:'en'},'English'));
    sel.value = state.Settings.Language || 'zh';
    sel.onchange = function(){ state.Settings.Language = sel.value; saveState(); render('settings'); };
    card.appendChild(sel);
    inline.appendChild(card);
    panel.appendChild(inline);
    root.appendChild(panel);
  })();
ensureSettings();
  root.appendChild(renderSimpleList('Category','Categories'));
  root.appendChild(renderSimpleList('Subcategory','Subcategories'));
  root.appendChild(renderSimpleList('Order Unit','OrderUnits'));
  root.appendChild(renderSimpleList('Count Freq','CountFreqs'));
  root.appendChild(renderIdRulePanel());
  root.appendChild(renderCodeTable('Category â†’ ä»£ç  æ˜ å°„','CategoryCodes','ä¾‹å¦‚ï¼šoolong'));
  root.appendChild(renderCodeTable('Subcategory â†’ ä»£ç  æ˜ å°„','SubcategoryCodes','ä¾‹å¦‚ï¼šFood (Packed)'));

  const impExp=el('div',{class:'panel'}, el('h3',{},'å¯¼å…¥ / å¯¼å‡º / å­˜å‚¨'),
    el('div',{class:'inline'},
      el('button',{class:'btn'},'ä¿å­˜åˆ°æµè§ˆå™¨'),
      el('button',{class:'btn'},'ä»æµè§ˆå™¨è¿˜åŸ'),
      el('button',{class:'btn danger'},'æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼ˆç½®ä¸ºç©ºç™½ï¼‰')
    ),
    el('div',{class:'inline',style:'margin-top:6px;'},
      el('button',{class:'btn primary'},'å¯¼å‡ºä¸º JSON'),
      el('button',{class:'btn'},'å¯¼å‡ºä¸º CSVï¼ˆå¤šæ–‡ä»¶ï¼‰'),
      el('button',{class:'btn'},'å¯¼å…¥ JSONï¼ˆæ›¿æ¢å…¨éƒ¨æ•°æ®ï¼‰')
    ),
    el('div',{style:'margin-top:6px;'},'è¯´æ˜ï¼šå¯¼å…¥æ”¯æŒ {"Items","Orders","Counts","Suppliers","Sales","BOM","Settings"} çš„å®Œæ•´æˆ–å­é›†ã€‚å¯¼å…¥åä¼šè‡ªåŠ¨åº”ç”¨å½“å‰IDè§„åˆ™ç”Ÿæˆç¼ºå¤± Item IDã€‚')
  );
  const btns=impExp.querySelectorAll('button');
  btns[0].onclick=function(){ saveState(); alert('å·²ä¿å­˜åˆ°æµè§ˆå™¨'); };
  btns[1].onclick=function(){ const saved=localStorage.getItem(KEY); if(!saved) return alert('æ²¡æœ‰å·²ä¿å­˜ç‰ˆæœ¬'); state=JSON.parse(saved); render('settings'); };
  btns[2].onclick=function(){ if(!confirm('ç¡®è®¤å°†æ‰€æœ‰æ•°æ®æ¸…ç©ºä¸ºã€ç©ºç™½ã€‘å¹¶ä¿å­˜ï¼Ÿ')) return; state=JSON.parse(JSON.stringify(originalData)); saveState(); render('settings'); };
  btns[3].onclick=function(){ download('Milk_Tea_App_Data.json', JSON.stringify(state, null, 2), 'application/json'); };
  btns[4].onclick=function(){ for(const k of Object.keys(state||{})){ const v=state[k]; if(Array.isArray(v)){ const csv=toCSV(v); download('Milk_Tea_'+k+'.csv', csv, 'text/csv'); } } };
  btns[5].onclick=function(){
    const f=byId('file_json'); f.value='';
    f.onchange=function(){
      const file=f.files && f.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=function(){
        try{
          const obj=JSON.parse(reader.result||'{}');
          const next={Items:[],Orders:[],Counts:[],Suppliers:[],Sales:[],BOM:[],Settings:{Categories:[],Subcategories:[],OrderUnits:[],CountFreqs:['7','15','30','60'], IdRules:{CategoryCodes:[],SubcategoryCodes:[]}, IdStrict:true}};
          if(typeof obj==='object' && obj){ for(const k of Object.keys(next)){ if(Array.isArray(obj[k])) next[k]=obj[k]; else if(k==='Settings' && typeof obj.Settings==='object') next.Settings=obj.Settings; } }
          (next.Items||[]).forEach(function(it){ it['Supplier']=normSupp(it['Supplier']); });
          (next.Orders||[]).forEach(function(o){ o['Supplier']=normSupp(o['Supplier']); o['PO Number']=normSupp(o['PO Number']); });
          (next.Suppliers||[]).forEach(function(s){ s['Supplier']=normSupp(s['Supplier']); });
          state=next; applyLeadTimesToItems(); autoAssignItemIDs(); saveState();
          alert('å¯¼å…¥æˆåŠŸ'); render('items');
        }catch(e){ alert('è§£æå¤±è´¥ï¼š'+e.message); }
      };
      reader.readAsText(file, 'utf-8');
    };
    f.click();
  };
  root.appendChild(impExp);
}

// ---------- Render ----------

// ---- Autosize inputs/selects ----
function _mt_measureText(text, font){
  const c = _mt_measureText.canvas || (_mt_measureText.canvas = document.createElement('canvas'));
  const ctx = c.getContext('2d');
  ctx.font = font || getComputedStyle(document.body).font;
  return ctx.measureText(text).width;
}
function autosizeField(el){
  if(!el || el.type==='checkbox') return;
  var cs = getComputedStyle(el);
  var font = cs.font;
  var text = el.tagName==='SELECT'
    ? ((el.options[el.selectedIndex] && el.options[el.selectedIndex].text) || '')
    : (el.value || el.placeholder || '');
  if(text==='') text=' ';
  var padding = 18;
  var minBase = 110;
  if(el.tagName==='SELECT') minBase = 120;
  else if((el.getAttribute('type')||'').toLowerCase()==='number') minBase = 96;
  var nm = (el.getAttribute('name')||'').trim();
  var col = (el.getAttribute('data-col')||'').trim();
  var key = nm || col;
  var overrides = {'Lead Time': 60,'Item ID':80,'Category':70,'Base Unit':70,'Order Unit':70,'Count Freq':50,'Lead Time':50,'Supplier':70};
  if(key && Object.prototype.hasOwnProperty.call(overrides,key)){ minBase = overrides[key]; }
  var px = Math.max(minBase, Math.ceil(_mt_measureText(text, font) + padding));
  el.style.width = px + 'px';
}
function autosizeAll(scope){
  scope = scope || document;
  const nodes = scope.querySelectorAll('input:not([type="checkbox"]), select, textarea');
  nodes.forEach(autosizeField);
}
document.addEventListener('input', function(e){
  if(e.target && (e.target.matches('input:not([type="checkbox"])') || e.target.matches('select') || e.target.matches('textarea'))){
    autosizeField(e.target);
  }
});
document.addEventListener('change', function(e){
  if(e.target && (e.target.matches('select'))){
    autosizeField(e.target);
  }
});


// ===== i18n helpers =====
function _mt_replaceTextNode(node, from, to){
  if(node.nodeType===Node.TEXT_NODE){
    if(node.textContent.indexOf(from) >= 0){
      node.textContent = node.textContent.split(from).join(to);
    }
  }else{
    for(const child of Array.from(node.childNodes)){ _mt_replaceTextNode(child, from, to); }
  }
}
function applyLanguage(scope){
  ensureSettings();
  const lang = (state.Settings && state.Settings.Language) || 'zh';
  scope = scope || document;
  const roots = [document.querySelector('header'), document.getElementById('tabs'), document.getElementById('view')];
  if(lang==='en'){
    const map = [
      ['å…¨éƒ¨','All'],
      ['ğŸ“¦ åº“å­˜æ€»è§ˆ','ğŸ“¦ Inventory'],
      ['ğŸ—‚ï¸ Items','ğŸ—‚ï¸ Items'], ['ğŸ§¾ Orders','ğŸ§¾ Orders'], ['ğŸ“‹ Counts','ğŸ“‹ Counts'], ['ğŸ·ï¸ Suppliers','ğŸ·ï¸ Suppliers'], ['âš™ï¸ è®¾ç½®','âš™ï¸ Settings'],
      ['ğŸ—‚ï¸ ç‰©æ–™','ğŸ—‚ï¸ Items'], ['ğŸ§¾ é‡‡è´­','ğŸ§¾ Orders'], ['ğŸ“‹ ç›˜ç‚¹','ğŸ“‹ Counts'], ['ğŸ·ï¸ ä¾›åº”å•†','ğŸ·ï¸ Suppliers'],
      ['ç­›é€‰ Category','Filter Category'],['ç­›é€‰ Subcategory','Filter Subcategory'],['ç­›é€‰ Supplier','Filter Supplier'],
      ['ä»…æ˜¾ç¤º Active','Show Active only'],['æ–°å¢ç‰©æ–™','Add Item'],['åˆ é™¤','Delete'],
      ['åˆ›å»ºæ–°çš„é‡‡è´­è®¢å•ï¼ˆPOï¼‰','Create new Purchase Order (PO)'],
      ['â³ Ongoingï¼ˆæœªæ”¶è´§æˆ–æœªåˆ°æœŸï¼‰','â³ Ongoing (not received || not due)'],['âœ… Deliveredï¼ˆå·²æ”¶è´§ï¼‰','âœ… Delivered (received)'],
      ['å¯¼å‡ºå½“å‰åº“å­˜æ€»è§ˆä¸º CSV','Export current inventory as CSV'],
      ['ç›˜ç‚¹æ—¥æœŸï¼š','Count Date:'],['æ–°å¢å•æ¡ç›˜ç‚¹','Add Single Count'],['ç”Ÿæˆæœ¬æ¬¡ç›˜ç‚¹æ¸…å•ï¼ˆæŒ‰ç­›é€‰æ¡ä»¶ï¼‰','Generate counting list (by Count Freq)'],
      ['ä¿å­˜/æ›´æ–°ä¾›åº”å•†','Save/Update Supplier'],['åˆ é™¤è¯¥ä¾›åº”å•†','Delete Supplier'],
      ['å¯¼å…¥ / å¯¼å‡º / å­˜å‚¨','Import / Export / Storage'],['ä¿å­˜åˆ°æµè§ˆå™¨','Save to Browser'],['ä»æµè§ˆå™¨è¿˜åŸ','Restore from Browser'],
      ['æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼ˆç½®ä¸ºç©ºç™½ï¼‰','Clear All Data (blank)'],['å¯¼å‡ºä¸º JSON','Export JSON'],['å¯¼å‡ºä¸º CSVï¼ˆå¤šæ–‡ä»¶ï¼‰','Export CSV (multi-file)'],['å¯¼å…¥ JSONï¼ˆæ›¿æ¢å…¨éƒ¨æ•°æ®ï¼‰','Import JSON (replace all)'],
      ['å€¼','Value'],['æ“ä½œ','Actions'],['æç¤º','Tips'],
      ['ä»…ä» Active ç‰©æ–™ä¸­æŒ‰æ‰€é€‰é¢‘ç‡ç”Ÿæˆç›˜ç‚¹æ¸…å•ï¼ˆé¿å…å¼•å…¥å·²åœç”¨ç‰©æ–™ï¼‰ã€‚','Generate only Active items by the selected frequency (avoid inactive items).'],
      ['Item ID è§„åˆ™ï¼ˆ4ä½ï¼šç¬¬1ä½=Categoryä»£ç ï¼Œç¬¬2ä½=Subcategoryä»£ç ï¼Œç¬¬3-4ä½=åç§°æ’åºåºå·ï¼‰','Item ID Rules (4 digits: 1st=Category code, 2nd=Subcategory code, 3-4=sequence by name)'],
      ['ä¸¥æ ¼æ¨¡å¼ï¼šæ— æ˜ å°„ä¸å…è®¸æ–°å¢ï¼ˆå…³é—­åå¯å…ˆæ–°å¢ï¼Œç¨åè¡¥å……è§„åˆ™å†ç»Ÿä¸€ç¼–å·ï¼‰','Strict Mode: Disallow adding without mappings (turn off to add first and renumber later)'],
      ['æŒ‰è§„åˆ™é‡æ–°ç”Ÿæˆæ‰€æœ‰ Item ID','Regenerate all Item IDs by rules'],
      ['Category â†’ ä»£ç  æ˜ å°„','Category â†’ Code Mapping'],['Subcategory â†’ ä»£ç  æ˜ å°„','Subcategory â†’ Code Mapping'],
      ['åç§°åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰','Name match (case-insensitive)'],['ä»£ç ï¼ˆå•ä¸ªæ•°å­—ï¼‰','Code (single digit)'],
      ['æ–°å»ºCategory','New Category'],['æ–°å»ºSubcategory','New Subcategory'],['æ–°å»ºOrder Unit','New Order Unit'],['æ–°å»ºCount Freq','New Count Freq'],
      ['é‡‡è´­å•: ','PO: '],['ä¾›åº”å•†: ','Supplier: '],['ä¸‹å•: ','Order: '],['é¢„è®¡åˆ°è´§: ','Expected: '],['åˆ°è´§: ','Deliver: '],
      ['ï¼ˆ',' (' ],['ï¼‰',')' ]
    ];
    for(const r of roots){ if(!r) continue; for(const [zh,en] of map) _mt_replaceTextNode(r, zh, en); }
  } else {
    const mapZH = [
      ['All','å…¨éƒ¨'],
      ['ğŸ“¦ Inventory','ğŸ“¦ åº“å­˜æ€»è§ˆ'],
      ['ğŸ—‚ï¸ Items','ğŸ—‚ï¸ ç‰©æ–™'],['ğŸ§¾ Orders','ğŸ§¾ é‡‡è´­'],['ğŸ“‹ Counts','ğŸ“‹ ç›˜ç‚¹'],['ğŸ·ï¸ Suppliers','ğŸ·ï¸ ä¾›åº”å•†'],['âš™ï¸ Settings','âš™ï¸ è®¾ç½®'],
      ['Filter Category','ç­›é€‰ Category'],['Filter Subcategory','ç­›é€‰ Subcategory'],['Filter Supplier','ç­›é€‰ Supplier'],
      ['Show Active only','ä»…æ˜¾ç¤º Active'],['Add Item','æ–°å¢ç‰©æ–™'],['Delete','åˆ é™¤'],
      ['Create new Purchase Order (PO)','åˆ›å»ºæ–°çš„é‡‡è´­è®¢å•ï¼ˆPOï¼‰'],
      ['Ongoing (not received || not due)','æœªæ”¶è´§æˆ–æœªåˆ°æœŸ'],['Delivered (received)','å·²æ”¶è´§'],
      ['Export current inventory as CSV','å¯¼å‡ºå½“å‰åº“å­˜æ€»è§ˆä¸º CSV'],
      ['Count Date:','ç›˜ç‚¹æ—¥æœŸï¼š'],['Add Single Count','æ–°å¢å•æ¡ç›˜ç‚¹'],['Generate counting list (by Count Freq)','ç”Ÿæˆæœ¬æ¬¡ç›˜ç‚¹æ¸…å•ï¼ˆæŒ‰ç­›é€‰æ¡ä»¶ï¼‰'],
      ['Save/Update Supplier','ä¿å­˜/æ›´æ–°ä¾›åº”å•†'],['Delete Supplier','åˆ é™¤è¯¥ä¾›åº”å•†'],
      ['Import / Export / Storage','å¯¼å…¥ / å¯¼å‡º / å­˜å‚¨'],['Save to Browser','ä¿å­˜åˆ°æµè§ˆå™¨'],['Restore from Browser','ä»æµè§ˆå™¨è¿˜åŸ'],
      ['Clear All Data (blank)','æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼ˆç½®ä¸ºç©ºç™½ï¼‰'],['Export JSON','å¯¼å‡ºä¸º JSON'],['Export CSV (multi-file)','å¯¼å‡ºä¸º CSVï¼ˆå¤šæ–‡ä»¶ï¼‰'],['Import JSON (replace all)','å¯¼å…¥ JSONï¼ˆæ›¿æ¢å…¨éƒ¨æ•°æ®ï¼‰'],
      ['Value','å€¼'],['Actions','æ“ä½œ'],['Tips','æç¤º'],
      ['Generate only Active items by the selected frequency (avoid inactive items).','ä»…ä» Active ç‰©æ–™ä¸­æŒ‰æ‰€é€‰é¢‘ç‡ç”Ÿæˆç›˜ç‚¹æ¸…å•ï¼ˆé¿å…å¼•å…¥å·²åœç”¨ç‰©æ–™ï¼‰ã€‚'],
      ['Item ID Rules (4 digits: 1st=Category code, 2nd=Subcategory code, 3-4=sequence by name)','Item ID è§„åˆ™ï¼ˆ4ä½ï¼šç¬¬1ä½=Categoryä»£ç ï¼Œç¬¬2ä½=Subcategoryä»£ç ï¼Œç¬¬3-4ä½=åç§°æ’åºåºå·ï¼‰'],
      ['Strict Mode: Disallow adding without mappings (turn off to add first and renumber later)','ä¸¥æ ¼æ¨¡å¼ï¼šæ— æ˜ å°„ä¸å…è®¸æ–°å¢ï¼ˆå…³é—­åå¯å…ˆæ–°å¢ï¼Œç¨åè¡¥å……è§„åˆ™å†ç»Ÿä¸€ç¼–å·ï¼‰'],
      ['Regenerate all Item IDs by rules','æŒ‰è§„åˆ™é‡æ–°ç”Ÿæˆæ‰€æœ‰ Item ID'],
      ['Category â†’ Code Mapping','Category â†’ ä»£ç  æ˜ å°„'],['Subcategory â†’ Code Mapping','Subcategory â†’ ä»£ç  æ˜ å°„'],
      ['Name match (case-insensitive)','åç§°åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰'],['Code (single digit)','ä»£ç ï¼ˆå•ä¸ªæ•°å­—ï¼‰'],
      ['New Category','æ–°å»ºCategory'],['New Subcategory','æ–°å»ºSubcategory'],['New Order Unit','æ–°å»ºOrder Unit'],['New Count Freq','æ–°å»ºCount Freq'],
      ['PO: ','é‡‡è´­å•: '],['Supplier: ','ä¾›åº”å•†: '],['Order: ','ä¸‹å•: '],['Expected: ','é¢„è®¡åˆ°è´§: '],['Deliver: ','åˆ°è´§: ']
    ];
    for(const r of roots){ if(!r) continue; for(const [en,zh] of mapZH) _mt_replaceTextNode(r, en, zh); }
  }
  // ---- Extended column/header translations ----
  if(lang==='en'){
    const mapExtraEN = [
      // Forms & columns (reverse: zh -> en)
      ['ç‰©æ–™ç¼–å·','Item ID'],
      ['ç‰©æ–™åç§°','Item Name'],
      ['ç±»åˆ«','Category'],
      ['å­ç±»åˆ«','Subcategory'],
      ['åŸºç¡€å•ä½','Base Unit'],
      ['è®¢è´­å•ä½','Order Unit'],
      ['æ¯è®¢è´­å•ä½å«åŸºç¡€å•ä½æ•°','Units per Order Unit'],
      ['é»˜è®¤å•ä»·/è®¢è´­å•ä½'],
      ['å®‰å…¨åº“å­˜ï¼ˆåŸºç¡€å•ä½ï¼‰','Safety Stock (base)'],
      ['ç›˜ç‚¹é¢‘ç‡','Count Freq'],
      ['ä¾›åº”å•†','Supplier'],
      ['äº¤æœŸ','Lead Time'],
      ['å¯ç”¨','Active'],
      ['è®¢å•è¿è´¹ï¼ˆä¸€æ¬¡æ€§ï¼‰','PO Shipping (enter once)'],
      ['åˆ°è´§æ—¥æœŸ','Receive Date'],
      ['ä¸‹å•æ—¥æœŸ','Order Date'],
      ['é¢„è®¡åˆ°è´§','Expected Delivery'],
      ['è®¢è´­æ•°é‡ï¼ˆè®¢è´­å•ä½ï¼‰','Qty Ordered (Order Unit)'],
      ['å•ä»·/è®¢è´­å•ä½','Unit Price / Order Unit'],
      ['è¡Œå°è®¡','Line Subtotal'],
      ['åˆ†æ‘Šè¿è´¹ï¼ˆè‡ªåŠ¨ï¼‰','Allocated Shipping (auto)'],
      ['è¡Œåˆè®¡','Line Total'],
      ['ç›˜ç‚¹æ•°é‡ï¼ˆåŸºç¡€å•ä½ï¼‰','Count Qty (base)'],
      ['å¤‡æ³¨','Notes'],
      ['è”ç³»äºº','Contact Name'],
      ['ç”µè¯','Phone'],
      ['é‚®ç®±','Email'],
      ['è¿è¾“æ—¶é—´ï¼ˆå¤©ï¼‰ï¼ˆæ‰‹åŠ¨ï¼‰','Shipping Time (days) (manual)'],
      ['å½“å‰åº“å­˜ï¼ˆé¢„ä¼°ï¼‰','Current Stock (Expected)'],
      ['æ—¥å‡æ¶ˆè€—','Avg Daily Usage'],
      ['å†è®¢è´­ç‚¹','Reorder Point'],
      ['å¯ç”¨å¤©æ•°','Days On Hand'],
      ['ä¸‹æ¬¡åˆ°è´§','Next Delivery'],
      ['è·åˆ°è´§å¤©æ•°','Days Until Delivery'],
      ['æœ€æ–°å•ä½æˆæœ¬','Latest Unit Cost'],
      ['å½“å‰åº“å­˜ä»·å€¼','Current Valuation'],
      ['çŠ¶æ€','Status'],
      ['æœ€è¿‘ç›˜ç‚¹æ—¥æœŸ','Last Count Date'],
      ['ç›˜ç‚¹åé”€å”®é‡ï¼ˆç†è®ºï¼‰','Sales Since Count (theoretical)'],
      ['ç›˜ç‚¹åå…¥åº“é‡','Received Since Count']
    ];
    for(const r of [document.getElementById('view')]){
      if(!r) continue;
      for(const [zh,en] of mapExtraEN){ _mt_replaceTextNode(r, zh, en); }
    }
  }else{
    const mapExtraZH = [
      // Forms & columns (en -> zh)
      ['Item ID','ç‰©æ–™ç¼–å·'],
      ['Item Name','ç‰©æ–™åç§°'],
      ['Category','ç±»åˆ«'],
      ['Subcategory','å­ç±»åˆ«'],
      ['Base Unit','åŸºç¡€å•ä½'],
      ['Order Unit','è®¢è´­å•ä½'],
      ['Units per Order Unit','æ¯è®¢è´­å•ä½å«åŸºç¡€å•ä½æ•°'],
      ['é»˜è®¤å•ä»·/è®¢è´­å•ä½'],
      ['Safety Stock (base)','å®‰å…¨åº“å­˜ï¼ˆåŸºç¡€å•ä½ï¼‰'],
      ['Count Freq','ç›˜ç‚¹é¢‘ç‡'],
      ['Supplier','ä¾›åº”å•†'],
      ['Lead Time','äº¤æœŸ'],
      ['Active','å¯ç”¨'],
      ['PO Shipping (enter once)','è®¢å•è¿è´¹ï¼ˆä¸€æ¬¡æ€§)'],
      ['Receive Date','åˆ°è´§æ—¥æœŸ'],
      ['Order Date','ä¸‹å•æ—¥æœŸ'],
      ['Expected Delivery','é¢„è®¡åˆ°è´§'],
      ['Qty Ordered (Order Unit)','è®¢è´­æ•°é‡ï¼ˆè®¢è´­å•ä½ï¼‰'],
      ['Unit Price / Order Unit','å•ä»·/è®¢è´­å•ä½'],
      ['Line Subtotal','è¡Œå°è®¡'],
      ['Allocated Shipping (auto)','åˆ†æ‘Šè¿è´¹ï¼ˆè‡ªåŠ¨ï¼‰'],
      ['Line Total','è¡Œåˆè®¡'],
      ['Count Qty (base)','ç›˜ç‚¹æ•°é‡ï¼ˆåŸºç¡€å•ä½ï¼‰'],
      ['Notes','å¤‡æ³¨'],
      ['Contact Name','è”ç³»äºº'],
      ['Phone','ç”µè¯'],
      ['Email','é‚®ç®±'],
      ['Shipping Time (days) (manual)','è¿è¾“æ—¶é—´ï¼ˆå¤©ï¼‰ï¼ˆæ‰‹åŠ¨)'],
      ['Current Stock (Expected)','å½“å‰åº“å­˜ï¼ˆé¢„ä¼°ï¼‰'],
      ['Avg Daily Usage','æ—¥å‡æ¶ˆè€—'],
      ['Reorder Point','å†è®¢è´­ç‚¹'],
      ['Days On Hand','å¯ç”¨å¤©æ•°'],
      ['Next Delivery','ä¸‹æ¬¡åˆ°è´§'],
      ['Days Until Delivery','è·åˆ°è´§å¤©æ•°'],
      ['Latest Unit Cost','æœ€æ–°å•ä½æˆæœ¬'],
      ['Current Valuation','å½“å‰åº“å­˜ä»·å€¼'],
      ['Status','çŠ¶æ€'],
      ['Last Count Date','æœ€è¿‘ç›˜ç‚¹æ—¥æœŸ'],
      ['Sales Since Count (theoretical)','ç›˜ç‚¹åé”€å”®é‡ï¼ˆç†è®ºï¼‰'],
      ['Received Since Count','ç›˜ç‚¹åå…¥åº“é‡']
    ];
    for(const r of [document.getElementById('view')]){
      if(!r) continue;
      for(const [en,zh] of mapExtraZH){ _mt_replaceTextNode(r, en, zh); }
    }
  }

}

function render(view='items'){
  try{
    const root=byId('view'); root.innerHTML='';
    const tabs=byId('tabs'); tabs.innerHTML='';
    VIEWS.forEach(function(v){ const b=el('button',{class:v.id===view?'active':''},v.label); b.onclick=function(){render(v.id);}; tabs.appendChild(b); });
    if(view==='inventory'){ renderInventory(root); }
else if(view==='items'){ renderItems(root); }
else if(view==='orders'){ renderOrders(root); }
else if(view==='counts'){ renderCounts(root); }
else if(view==='suppliers'){ renderSuppliers(root); }
else if(view==='calculator'){ renderCalculator(root); }
else if(view==='reorder'){ renderReorder(root); }
else if(view==='settings'){ renderSettings(root); }
}
  catch(e){ showErr('æ¸²æŸ“é”™è¯¯ï¼š'+e.message, e.stack); }
  applyLanguage(document);
}

// åˆå§‹ï¼šè‹¥ç¼ºå¤±IDï¼ŒæŒ‰è§„åˆ™ç”Ÿæˆ
autoAssignItemIDs();
render('items');

// === Adjustments for Inventory and Counts ===
const __oldRenderInventory = renderInventory;
renderInventory = function(root){
  __oldRenderInventory(root);
  root.querySelectorAll('tbody tr').forEach(tr => {
    const cells = tr.querySelectorAll('td input');
    if(cells.length >= 5){
      // å½“å‰åº“å­˜
      let stockInput = cells[2];
      if(stockInput && !isNaN(stockInput.value)){
        let v = parseFloat(stockInput.value);
        if(v < 0){ stockInput.value = "0.00"; }
      }
      // å¯ç”¨å¤©æ•°
      let daysInput = cells[4];
      if(daysInput && !isNaN(daysInput.value)){
        let v = parseFloat(daysInput.value);
        if(v < 0){ daysInput.value = "0.00"; }
      }
    }
  });
};

const __oldRenderCounts = renderCounts;
renderCounts = function(root){
  __oldRenderCounts(root);
  root.querySelectorAll('input[name="Count Qty (base)"]').forEach(inp => {
    inp.type = 'text';
  });
  root.querySelectorAll('input[data-col="Count Qty (base)"]').forEach(inp => {
    inp.type = 'text';
  });
};
</script>
<!-- Settings compact patch v2 -->
<script>
(function(){
  if (window.__settingsCompactPatched) return;
  window.__settingsCompactPatched = true;

  // Scoped CSS
  var style = document.createElement('style');
  style.textContent = `
  #view.settings-compact .panel{margin:10px 0;padding:10px;border-radius:12px}
  #view.settings-compact .sections-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
  #view.settings-compact .sections-grid.tight{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  #view.settings-compact .btn{padding:6px 10px;border-radius:10px}
  #view.settings-compact .inline{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
  #view.settings-compact .card{padding:8px}
  #view.settings-compact label{font-size:12px;color:#a6b3cf}
  #view.settings-compact input,
  #view.settings-compact select,
  #view.settings-compact textarea{width:auto;min-width:96px;max-width:100%}
  #view.settings-compact input[type="number"]{min-width:84px}
  #view.settings-compact select{min-width:104px}
  #view.settings-compact h3{margin:0 0 8px 0;font-size:14px;opacity:.9}
  `;
  document.head.appendChild(style);

  // Wrap renderSettings to compact the layout after original rendering
  var _renderSettings = window.renderSettings;
  if(!_renderSettings) return;
  window.renderSettings = function(root){
    _renderSettings(root);
    root.classList.add('settings-compact');

    // Helper: find direct child panels by title text
    function findPanelByH3(text){
      var panels = Array.from(root.querySelectorAll(':scope > .panel'));
      return panels.find(function(p){
        var h = p.querySelector(':scope > h3');
        return h && (h.textContent || '').trim().indexOf(text) === 0;
      });
    }

    // Collect panels
    var pLang = findPanelByH3('è¯­è¨€') || findPanelByH3('Language');
    var pCat = findPanelByH3('Category');
    var pSub = findPanelByH3('Subcategory');
    var pOU = findPanelByH3('Order Unit');
    var pCF = findPanelByH3('Count Freq');
    var pRule = findPanelByH3('Item ID è§„åˆ™');
    var pMapCat = findPanelByH3('Category â†’') || findPanelByH3('Category â†’ Code');
    var pMapSub = findPanelByH3('Subcategory â†’') || findPanelByH3('Subcategory â†’ Code');
    var pImp = findPanelByH3('å¯¼å…¥') || findPanelByH3('Import ');

    // Group the four simple lists into a sections grid
    if(pCat && pSub && pOU && pCF){
      var grid = document.createElement('div');
      grid.className = 'panel sections-grid tight';
      var title = document.createElement('h3');
      title.textContent = 'åŸºç¡€å­—å…¸ / Core Lists';
      grid.appendChild(title);
      [pCat, pSub, pOU, pCF].forEach(function(p){
        if(p && p.parentElement===root) grid.appendChild(p);
      });
      root.insertBefore(grid, (pRule||pMapCat||pMapSub||pImp||null));
    }

    // Group the two code-mapping tables
    if(pMapCat && pMapSub){
      var grid2 = document.createElement('div');
      grid2.className = 'panel sections-grid';
      var title2 = document.createElement('h3');
      title2.textContent = 'ID æ˜ å°„ / ID Mappings';
      grid2.appendChild(title2);
      [pMapCat, pMapSub].forEach(function(p){
        if(p && p.parentElement===root) grid2.appendChild(p);
      });
      root.insertBefore(grid2, pImp||null);
    }

    // Keep Item ID è§„åˆ™é¢æ¿é å‰ï¼Œå¯¼å…¥å¯¼å‡ºé åï¼Œæ— éœ€æ”¹å˜å…¶å†…éƒ¨ç»“æ„

    // Tighten Import/Export button rows
    if(pImp){
      pImp.querySelectorAll(':scope > .inline').forEach(function(row){
        row.classList.add('inline'); // ensure class present
        row.style.marginTop = '0';
      });
    }

    // Settings-only autosize baseline
    var _auto = window.autosizeField;
    if(typeof _auto === 'function' && !_auto.__settingsCompactWrapped){
      var measure = window._mt_measureText;
      window.autosizeField = function(el){
        if(!el || el.type==='checkbox'){ return _auto(el); }
        var inSettings = el.closest && el.closest('#view.settings-compact');
        if(!inSettings){ return _auto(el); }
        var cs = getComputedStyle(el);
        var font = cs.font;
        var text = el.tagName==='SELECT'
          ? ((el.options[el.selectedIndex] && el.options[el.selectedIndex].text) || '')
          : (el.value || el.placeholder || '');
        if(text==='') text=' ';
        var padding = 16;
        var minBase = 96;
        if(el.tagName==='SELECT') minBase = 104;
        else if((el.getAttribute('type')||'').toLowerCase()==='number') minBase = 84;
        var px = Math.max(minBase, Math.ceil(measure(text, font) + padding));
        el.style.width = px + 'px';
      };
      window.autosizeField.__settingsCompactWrapped = true;
    }

    // Re-apply autosize on settings view
    if(typeof window.autosizeAll === 'function'){
      window.autosizeAll(root);
    }
  };
})();
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker
        .register('./service-worker.js')
        .catch(function(err){
          console.log('Service Worker æ³¨å†Œå¤±è´¥ï¼š', err);
        });
    });
  }
</script>

</body>
</html>